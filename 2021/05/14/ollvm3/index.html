<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>使用unidbg还原标准ollvm的fla控制流程平坦化 | king的博客</title><meta name="keywords" content="反混淆"><meta name="author" content="king"><meta name="copyright" content="king"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="最近网上查了查还原平坦化相关的资料。看了无名侠大佬的文章。由于本人太菜了。好多地方看的有点懵懵懂懂的。最终还是自己摸索着尝试还原平坦化。写的哪里不对。还请大佬指正。 先贴上几位大佬的文章 [ARM64 OLLVM反混淆][https:&#x2F;&#x2F;bbs.pediy.com&#x2F;thread-252321.htm] [利用符号执行去除控制流平坦化][https:&#x2F;&#x2F;security.tencent.com&#x2F;in">
<meta property="og:type" content="article">
<meta property="og:title" content="使用unidbg还原标准ollvm的fla控制流程平坦化">
<meta property="og:url" content="http://missking.cc/2021/05/14/ollvm3/index.html">
<meta property="og:site_name" content="king的博客">
<meta property="og:description" content="最近网上查了查还原平坦化相关的资料。看了无名侠大佬的文章。由于本人太菜了。好多地方看的有点懵懵懂懂的。最终还是自己摸索着尝试还原平坦化。写的哪里不对。还请大佬指正。 先贴上几位大佬的文章 [ARM64 OLLVM反混淆][https:&#x2F;&#x2F;bbs.pediy.com&#x2F;thread-252321.htm] [利用符号执行去除控制流平坦化][https:&#x2F;&#x2F;security.tencent.com&#x2F;in">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
<meta property="article:published_time" content="2021-05-14T20:15:49.000Z">
<meta property="article:modified_time" content="2022-09-05T12:58:31.092Z">
<meta property="article:author" content="king">
<meta property="article:tag" content="反混淆">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://missking.cc/2021/05/14/ollvm3/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '使用unidbg还原标准ollvm的fla控制流程平坦化',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-09-05 12:58:31'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.0.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/assets/blogImg/litten.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">36</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">16</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/contact/"><i class="fa-fw fas fa-comment-dots"></i><span> 留言板</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">king的博客</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/contact/"><i class="fa-fw fas fa-comment-dots"></i><span> 留言板</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">使用unidbg还原标准ollvm的fla控制流程平坦化</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-05-14T20:15:49.000Z" title="发表于 2021-05-14 20:15:49">2021-05-14</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-09-05T12:58:31.092Z" title="更新于 2022-09-05 12:58:31">2022-09-05</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="使用unidbg还原标准ollvm的fla控制流程平坦化"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>最近网上查了查还原平坦化相关的资料。看了无名侠大佬的文章。由于本人太菜了。好多地方看的有点懵懵懂懂的。最终还是自己摸索着尝试还原平坦化。写的哪里不对。还请大佬指正。</p>
<p>先贴上几位大佬的文章</p>
<p>[ARM64 OLLVM反混淆][<a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-252321.htm]">https://bbs.pediy.com/thread-252321.htm]</a></p>
<p>[利用符号执行去除控制流平坦化][<a target="_blank" rel="noopener" href="https://security.tencent.com/index.php/blog/msg/112]">https://security.tencent.com/index.php/blog/msg/112]</a></p>
<p>翻阅过大佬的文章后。本菜菜得到两个简单的结论。</p>
<p><strong>一、fla主要功能是将if else这类的逻辑给转换成while+switch组合来处理。达到将简单的逻辑给复杂化，增加静态分析难度的目的。</strong></p>
<p><strong>二、模拟执行找出真实块之间的关联，patch修改相应的代码。直接将真实块关联起来，从而实现反混淆</strong></p>
<a id="more"></a>

<p>接下来。我将采用先射箭后画靶的方式。来逐步的还原一个标准的ollvm fla的案例。</p>
<p>首先是准备我们的案例，如下是未混淆前的源码</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="built_in">std</span>::<span class="built_in">string</span> <span class="title">calcKey</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">string</span> data)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (data.length()&gt;<span class="number">10</span>)&#123;</span><br><span class="line">        data=<span class="string">&quot;ceshi&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(data.length()&gt;<span class="number">30</span>)&#123;</span><br><span class="line">        data=<span class="string">&quot;ollvm&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        data=<span class="string">&quot;fla&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> JNIEXPORT jstring JNICALL</span><br><span class="line">Java_com_example_ollvmdemo2_MainActivity_stringFromJNI(</span><br><span class="line">        JNIEnv *env,</span><br><span class="line">        jobject <span class="comment">/* this */</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> hello = <span class="string">&quot;Hello from C++&quot;</span>;</span><br><span class="line">    hello=calcKey(hello);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> env-&gt;NewStringUTF(hello.c_str());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后是混淆的参数配置是<code>add_definitions(&quot;-mllvm -fla -mllvm -split -mllvm -split_num=3&quot;)</code></p>
<p>贴上混淆后的样本：链接: <a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1Dd0T49xhsjgWrJw7PSTQFA">https://pan.baidu.com/s/1Dd0T49xhsjgWrJw7PSTQFA</a>  密码: rrem</p>
<p>然后贴上ida解析出来的代码</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> __int64 __usercall calcKey@&lt;X0&gt;(<span class="keyword">unsigned</span> __int64 result@&lt;X0&gt;, __int64 a2@&lt;X8&gt;)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v2; <span class="comment">// w8</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v3; <span class="comment">// w8</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v4; <span class="comment">// [xsp+10h] [xbp-40h]</span></span><br><span class="line">  __int64 v5; <span class="comment">// [xsp+18h] [xbp-38h]</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v6; <span class="comment">// [xsp+24h] [xbp-2Ch]</span></span><br><span class="line">  <span class="keyword">bool</span> v7; <span class="comment">// [xsp+3Fh] [xbp-11h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v8; <span class="comment">// [xsp+40h] [xbp-10h]</span></span><br><span class="line">  <span class="keyword">bool</span> v9; <span class="comment">// [xsp+4Fh] [xbp-1h]</span></span><br><span class="line"></span><br><span class="line">  v6 = <span class="number">910266824</span>;</span><br><span class="line">  v5 = a2;</span><br><span class="line">  v4 = result;</span><br><span class="line">  <span class="keyword">while</span> ( v6 != <span class="number">-1929161090</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">switch</span> ( v6 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">-1578842400</span>:</span><br><span class="line">        v6 = <span class="number">56578246</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">-1521928633</span>:</span><br><span class="line">        v9 = v8 &gt; <span class="number">0x1E</span>;</span><br><span class="line">        v6 = <span class="number">-124633339</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">-124633339</span>:</span><br><span class="line">        <span class="keyword">if</span> ( v9 )</span><br><span class="line">          v3 = <span class="number">1872828810</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          v3 = <span class="number">1744272424</span>;</span><br><span class="line">        v6 = v3;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">56578246</span>:</span><br><span class="line">        v6 = <span class="number">1089662144</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">256858465</span>:</span><br><span class="line">        <span class="keyword">if</span> ( v7 )</span><br><span class="line">          v2 = <span class="number">1938015978</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          v2 = <span class="number">1363893773</span>;</span><br><span class="line">        v6 = v2;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">910266824</span>:</span><br><span class="line">        v6 = <span class="number">2056492010</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1089662144</span>:</span><br><span class="line">        result = sub_F8E4(v5, v4);</span><br><span class="line">        v6 = <span class="number">-1929161090</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1363893773</span>:</span><br><span class="line">        result = sub_F77C(v4);</span><br><span class="line">        v8 = result;</span><br><span class="line">        v6 = <span class="number">-1521928633</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1493239651</span>:</span><br><span class="line">        v6 = <span class="number">1089662144</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1697837166</span>:</span><br><span class="line">        v6 = <span class="number">56578246</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1744272424</span>:</span><br><span class="line">        result = sub_F830(v4, <span class="string">&quot;fla&quot;</span>);</span><br><span class="line">        v6 = <span class="number">1697837166</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1872828810</span>:</span><br><span class="line">        result = sub_F830(v4, <span class="string">&quot;ollvm&quot;</span>);</span><br><span class="line">        v6 = <span class="number">-1578842400</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1938015978</span>:</span><br><span class="line">        result = sub_F830(v4, <span class="string">&quot;ceshi&quot;</span>);</span><br><span class="line">        v6 = <span class="number">1493239651</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2056492010</span>:</span><br><span class="line">        result = sub_F77C(v4);</span><br><span class="line">        v7 = result &gt; <span class="number">0xA</span>;</span><br><span class="line">        v6 = <span class="number">256858465</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们对比看下混淆前和混淆后的代码。原本我们只需要看if条件就知道意义的。但是现在就需要不停的顺着条件。进入case一步步的分析每一步。如果是这么简单的例子。我们还是可以静态分析看的出来真正的条件。但是代码量过于庞大时就很难跟踪分析了。</p>
<h2 id="思路：先射箭后画靶"><a href="#思路：先射箭后画靶" class="headerlink" title="思路：先射箭后画靶"></a>思路：先射箭后画靶</h2><p>先简单说下如何先射箭后画靶，上面这个例子的逻辑比较简单。初学的情况，我们可以直接静态分析下，找出所有的真实块。然后用ida的keypatch插件来手动将真实块关联起来。再用ida解析看看结果是否和我们的混淆前的一致。结果一致后。我们就可以开始写unidbg代码来根据特征匹配真实块。特征匹配的结果可以和我们静态分析的结果对比看是否一致。最后只要unidbg实现出我们手动关联的效果，就完成了自动化反混淆了。下面我就先手动的还原。</p>
<h2 id="一、手动还原"><a href="#一、手动还原" class="headerlink" title="一、手动还原"></a>一、手动还原</h2><p>1、找出所有真实块以及对应的汇编地址，标准的ollvm虚假块中一般只有简单的修改v6的值，其他的基本都是真实块</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">-1521928633</span>:                            <span class="comment">//0xF694</span></span><br><span class="line">        v9 = v8 &gt; <span class="number">0x1E</span>;</span><br><span class="line">        v6 = <span class="number">-124633339</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="number">-124633339</span>:                            <span class="comment">//0xF6BC</span></span><br><span class="line">        <span class="keyword">if</span> ( v9 )</span><br><span class="line">          v3 = <span class="number">1872828810</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          v3 = <span class="number">1744272424</span>;</span><br><span class="line">        v6 = v3;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="number">256858465</span>:                                <span class="comment">//0xF624</span></span><br><span class="line">        <span class="keyword">if</span> ( v7 )</span><br><span class="line">          v2 = <span class="number">1938015978</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          v2 = <span class="number">1363893773</span>;</span><br><span class="line">        v6 = v2;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="number">1089662144</span>:                            <span class="comment">//0xF750</span></span><br><span class="line">        result = sub_F8E4(v5, v4);</span><br><span class="line">        v6 = <span class="number">-1929161090</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="number">1363893773</span>:                            <span class="comment">//0xF678</span></span><br><span class="line">        result = sub_F77C(v4);</span><br><span class="line">        v8 = result;</span><br><span class="line">        v6 = <span class="number">-1521928633</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="number">1744272424</span>:                            <span class="comment">//0xF710</span></span><br><span class="line">        result = sub_F830(v4, <span class="string">&quot;fla&quot;</span>);</span><br><span class="line">        v6 = <span class="number">1697837166</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="number">1872828810</span>:                            <span class="comment">//0xF6E0</span></span><br><span class="line">        result = sub_F830(v4, <span class="string">&quot;ollvm&quot;</span>);</span><br><span class="line">        v6 = <span class="number">-1578842400</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="number">1938015978</span>:                            <span class="comment">//0xF648</span></span><br><span class="line">        result = sub_F830(v4, <span class="string">&quot;ceshi&quot;</span>);</span><br><span class="line">        v6 = <span class="number">1493239651</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="number">2056492010</span>:                            <span class="comment">//0xF5F8</span></span><br><span class="line">                result = sub_F77C(v4);</span><br><span class="line">        v7 = result &gt; <span class="number">0xA</span>;</span><br><span class="line">        v6 = <span class="number">256858465</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<p>找出所有真实块的地址后。接着就是顺着逻辑将他们全部串联起来。这里我举两个比较典型的例子。先从函数开始的地方开始。下面简单整理下第一个真实块的关联</p>
<p>根据v6=910266824第一次赋值。我们锁定到下面的case分支</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> __int64 __usercall calcKey@&lt;X0&gt;(<span class="keyword">unsigned</span> __int64 result@&lt;X0&gt;, __int64 a2@&lt;X8&gt;)</span><br><span class="line">&#123;</span><br><span class="line">  v6 = <span class="number">910266824</span>;</span><br><span class="line">  v5 = a2;</span><br><span class="line">  v4 = result;</span><br><span class="line">  <span class="keyword">while</span> ( v6 != <span class="number">-1929161090</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">switch</span> ( v6 )</span><br><span class="line">    &#123;</span><br><span class="line">      ....</span><br><span class="line">      <span class="keyword">case</span> <span class="number">910266824</span>:</span><br><span class="line">        v6 = <span class="number">2056492010</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      ....</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2056492010</span>:                            <span class="comment">//0xF5F8        第一个真实块</span></span><br><span class="line">        result = sub_F77C(v4);</span><br><span class="line">        v7 = result &gt; <span class="number">0xA</span>;</span><br><span class="line">        v6 = <span class="number">256858465</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">     ....</span><br><span class="line">     <span class="keyword">case</span> <span class="number">256858465</span>:                                <span class="comment">//0xF624        第二个真实块</span></span><br><span class="line">        <span class="keyword">if</span> ( v7 )</span><br><span class="line">          v2 = <span class="number">1938015978</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          v2 = <span class="number">1363893773</span>;</span><br><span class="line">        v6 = v2;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据上面的代码。我们第一个真实块。应该是直接跳转到0xF5F8这个位置。而第一个跳转的位置。应该是在while循环前。先贴上第一个block的汇编代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.text:000000000000F470 loc_F470                             </span><br><span class="line">.text:000000000000F470                 LDR             W8, [SP,#0x50+var_2C]</span><br><span class="line">.text:000000000000F474                 MOV             W9, #0x567E</span><br><span class="line">.text:000000000000F478                 MOVK            W9, #0x8D03,LSL#16</span><br><span class="line">.text:000000000000F47C                 CMP             W8, W9</span><br><span class="line">.text:000000000000F480                 STR             W8, [SP,#0x50+var_44]</span><br><span class="line">.text:000000000000F484                 B.EQ            loc_F76C</span><br><span class="line">.text:000000000000F488                 B               loc_F48C</span><br></pre></td></tr></table></figure>

<p>我们可以直接第一句就跳转到真实指令。因为这里使用的while是fla混淆的所以这些数据我们并不需要去执行。修改代码如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.text:000000000000F470 loc_F470                           </span><br><span class="line">.text:000000000000F470                 LDR             W8, [SP,#0x50+var_2C]</span><br><span class="line">.text:000000000000F474                 B               loc_F5F8 ; Keypatch modified this from:</span><br><span class="line">.text:000000000000F474                                         ;   MOV W9, #0x567E</span><br><span class="line">.text:000000000000F478 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:000000000000F478                 MOVK            W9, #0x8D03,LSL#16</span><br><span class="line">.text:000000000000F47C                 CMP             W8, W9</span><br><span class="line">.text:000000000000F480                 STR             W8, [SP,#0x50+var_44]</span><br><span class="line">.text:000000000000F484                 B.EQ            loc_F76C</span><br><span class="line">.text:000000000000F488                 B               loc_F48C</span><br></pre></td></tr></table></figure>

<p>这样第一个块就关联好了。然后继续关联第二个真实块0xF624。下面先列出第一个真实块的汇编</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">.text:000000000000F5F8 loc_F5F8                                </span><br><span class="line">.text:000000000000F5F8                                     </span><br><span class="line">.text:000000000000F5F8                 LDR             X0, [SP,#0x50+var_40]</span><br><span class="line">.text:000000000000F5FC                 BL              sub_F77C</span><br><span class="line">.text:000000000000F600                 CMP             X0, #0xA</span><br><span class="line">.text:000000000000F604                 CSET            W8, HI</span><br><span class="line">.text:000000000000F608                 MOV             W9, #1</span><br><span class="line">.text:000000000000F60C                 AND             W8, W8, W9</span><br><span class="line">.text:000000000000F610                 STURB           W8, [X29,#var_11]</span><br><span class="line">.text:000000000000F614                 MOV             W8, #0x5961</span><br><span class="line">.text:000000000000F618                 MOVK            W8, #0xF4F,LSL#16</span><br><span class="line">.text:000000000000F61C                 STR             W8, [SP,#0x50+var_2C]</span><br><span class="line">.text:000000000000F620                 B               loc_F778</span><br></pre></td></tr></table></figure>

<p>汇编的最后是跳转到了0xf778。这里就是又进入控制分发器了。我们直接让他跳转到第二个真实块。修改最后一行汇编如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.text:000000000000F618                 MOVK            W8, #0xF4F,LSL#16</span><br><span class="line">.text:000000000000F61C                 STR             W8, [SP,#0x50+var_2C]</span><br><span class="line">.text:000000000000F620                 B               loc_F624 ; Keypatch modified this from:</span><br><span class="line">.text:000000000000F620                                         ;   B loc_F778</span><br></pre></td></tr></table></figure>

<p>第二个真实块这里就有点特殊了。这是一个分支让我们的第三个真实块可能是0xF648位置也可能是0xF678位置。我们先看看c++的部分</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">256858465</span>:</span><br><span class="line">        <span class="keyword">if</span> ( v7 )                <span class="comment">//根据条件让第三个真实块不固定了</span></span><br><span class="line">          v2 = <span class="number">1938015978</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          v2 = <span class="number">1363893773</span>;</span><br><span class="line">        v6 = v2;</span><br></pre></td></tr></table></figure>

<p>那么这里我们就不能简单的b跳转哪个真实块了。这里我的预想是把这块的代码修改成如下</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">256858465</span>:</span><br><span class="line">        <span class="keyword">if</span> ( v7 )                <span class="comment">//根据条件让第三个真实块不固定了</span></span><br><span class="line">          <span class="comment">//直接跳转到0xF648</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          <span class="comment">//直接跳转到0xF678</span></span><br><span class="line">        v6 = v2;</span><br></pre></td></tr></table></figure>

<p>但是我们肯定不能修改c++的代码。所以看看这个真实块的汇编部分</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">.text:000000000000F624 loc_F624                                </span><br><span class="line">.text:000000000000F624                                         </span><br><span class="line">.text:000000000000F624                 LDURB           W8, [X29,#var_11]</span><br><span class="line">.text:000000000000F628                 MOV             W9, #0xC6EA</span><br><span class="line">.text:000000000000F62C                 MOVK            W9, #0x7383,LSL#16</span><br><span class="line">.text:000000000000F630                 MOV             W10, #0x5E0D</span><br><span class="line">.text:000000000000F634                 MOVK            W10, #0x514B,LSL#16</span><br><span class="line">.text:000000000000F638                 TST             W8, #1</span><br><span class="line">.text:000000000000F63C                 CSEL            W8, W9, W10, NE</span><br><span class="line">.text:000000000000F640                 STR             W8, [SP,#0x50+var_2C]</span><br><span class="line">.text:000000000000F644                 B               loc_F778</span><br></pre></td></tr></table></figure>

<p>这里可以看到那个v7的值就是w8。所以我们修改成判断w8=1。就跳转到0xf648。否则跳转到0xf678。下面贴上修改后的结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">.text:000000000000F624 loc_F624                                </span><br><span class="line">.text:000000000000F624                                         </span><br><span class="line">.text:000000000000F624                 LDURB           W8, [X29,#var_11]</span><br><span class="line">.text:000000000000F628                 MOV             W9, #0xC6EA</span><br><span class="line">.text:000000000000F62C                 MOVK            W9, #0x7383,LSL#16</span><br><span class="line">.text:000000000000F630                 MOV             W10, #0x5E0D</span><br><span class="line">.text:000000000000F634                 MOVK            W10, #0x514B,LSL#16</span><br><span class="line">.text:000000000000F638                 CMP             W8, #1  ; Keypatch modified this from:</span><br><span class="line">.text:000000000000F638                                         ;   TST W8, #1</span><br><span class="line">.text:000000000000F63C                 B.EQ            loc_F648 ; Keypatch modified this from:</span><br><span class="line">.text:000000000000F63C                                         ;   CSEL W8, W9, W10, NE</span><br><span class="line">.text:000000000000F640                 B               loc_F678 ; Keypatch modified this from:</span><br><span class="line">.text:000000000000F640                                         ;   STR W8, [SP,#0x50+var_2C]</span><br></pre></td></tr></table></figure>

<p>再往后基本就都是这两种方式关联了。下面我就直接列一下手动修改后的跳转关联</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">0xF474        ---&gt;        0xF5F8</span><br><span class="line">0xF620        ---&gt;        0xF624</span><br><span class="line">0xF63C        ---&gt;        0xF648</span><br><span class="line">0xF640        ---&gt;        0xF678</span><br><span class="line">0xF664        ---&gt;        0xF750</span><br><span class="line">0xF690        ---&gt;        0xF694</span><br><span class="line">0xF6B8        ---&gt;        0xF6BC</span><br><span class="line">0xF6D4        ---&gt;        0xF6E0</span><br><span class="line">0xF6D8        ---&gt;        0xF710</span><br><span class="line">0xF6FC        ---&gt;        0xF750</span><br></pre></td></tr></table></figure>

<p>上面的跳转修改完后。最后把让我们while循环的跳转给改成nop。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.text:000000000000F778 loc_F778                                </span><br><span class="line">.text:000000000000F778                                        </span><br><span class="line">.text:000000000000F778                 B               loc_F470            &#x2F;&#x2F;修改成nop</span><br></pre></td></tr></table></figure>

<p>最后我们f5解析一下。基本结果就差不多了。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __usercall <span class="title">calcKey</span><span class="params">(<span class="keyword">unsigned</span> __int64 result@&lt;X0&gt;, __int64 a2@&lt;X8&gt;)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v2; <span class="comment">// x0</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v3; <span class="comment">// [xsp+10h] [xbp-40h]</span></span><br><span class="line">  __int64 v4; <span class="comment">// [xsp+18h] [xbp-38h]</span></span><br><span class="line">  <span class="keyword">bool</span> v5; <span class="comment">// [xsp+4Fh] [xbp-1h]</span></span><br><span class="line"></span><br><span class="line">  v4 = a2;</span><br><span class="line">  v3 = result;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int64)sub_F77C(result) &gt; <span class="number">0xA</span> == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    sub_F830(v3, <span class="string">&quot;ceshi&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v5 = (<span class="keyword">unsigned</span> __int64)sub_F77C(v3) &gt; <span class="number">0x1E</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v5 == <span class="number">1</span> )</span><br><span class="line">      sub_F830(v3, <span class="string">&quot;ollvm&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      sub_F830(v3, <span class="string">&quot;fla&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  v2 = sub_F8E4(v4, v3);</span><br><span class="line">  sub_F77C(v2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="二、自动化反混淆"><a href="#二、自动化反混淆" class="headerlink" title="二、自动化反混淆"></a>二、自动化反混淆</h2><p>第一步先用unidbg跑通流程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FlaTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AndroidEmulator emulator;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> VM vm;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DvmClass mainActivityDvm;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        FlaTest bcfTest = <span class="keyword">new</span> FlaTest();</span><br><span class="line">        bcfTest.call_calckey();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">FlaTest</span><span class="params">()</span></span>&#123;</span><br><span class="line">        emulator = AndroidEmulatorBuilder</span><br><span class="line">                .for64Bit()</span><br><span class="line">                .build();</span><br><span class="line">        Memory memory = emulator.getMemory();</span><br><span class="line">        LibraryResolver resolver = <span class="keyword">new</span> AndroidResolver(<span class="number">23</span>);</span><br><span class="line">        memory.setLibraryResolver(resolver);</span><br><span class="line">        vm = emulator.createDalvikVM(<span class="keyword">null</span>);</span><br><span class="line">        vm.setVerbose(<span class="keyword">false</span>);</span><br><span class="line">        mainActivityDvm = vm.resolveClass(<span class="string">&quot;com/example/ollvmdemo2/MainActivity&quot;</span>);</span><br><span class="line">        DalvikModule dm = vm.loadLibrary(<span class="keyword">new</span> File(<span class="string">&quot;unidbg-android/src/test/resources/example_binaries/ollvm_fla/libnative-lib.so&quot;</span>), <span class="keyword">false</span>);</span><br><span class="line">        dm.callJNI_OnLoad(emulator);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//主动调用目标函数</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">call_calckey</span><span class="params">()</span></span>&#123;</span><br><span class="line">        StringObject res = mainActivityDvm.callStaticJniMethodObject(emulator, <span class="string">&quot;stringFromJNI()Ljava/lang/String;&quot;</span>);</span><br><span class="line">        System.out.println(res.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先找找真实块和混淆块的特征，然后区分它们。可以看出来这个案例中的控制流程只要靠v6这个变量来驱动。真实块中有条件判断。有函数调用。而混淆块中只有对v6的修改。接下来看看混淆块的汇编代码是什么样的。当然不同的混淆参数也会导致特征不一样。要根据实际情况来进行调整。下面是一个混淆块</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.text:000000000000F700 loc_F700  </span><br><span class="line">.text:000000000000F700                 MOV             W8, #0x50C6</span><br><span class="line">.text:000000000000F704                 MOVK            W8, #0x35F,LSL#16</span><br><span class="line">.text:000000000000F708                 STR             W8, [SP,#0x50+var_2C]</span><br><span class="line">.text:000000000000F70C                 B               loc_F778</span><br></pre></td></tr></table></figure>

<p>这个例子的混淆特征就是一个4行指令的block。mov、movk、str、b。由于我们看到例子中用于驱动控制流程的变量是同一个。所以str的写入地址也可以当做特征。如果无法通过混淆block的特征区分精准。就通过真实块的特征区分。比如block中有bl指令跳转到函数的是真实块。有运算符操作的是真实块。有条件判断的是真实块</p>
<p>能够区分出混淆块和真实块之后。最后的工作就是完成block之间的关系连接。找出所有的真实块。然后直接跳转过去</p>
<p>还原流程分析完后。接着列一下实现的步骤</p>
<p>1、将所有执行的block保存下来</p>
<p>2、遍历所有block。将真实的block筛选出来</p>
<p>3、遍历所有真实block。用b指令将他们串联起来。</p>
<p>下面是保存所有执行块的代码部分</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//用来保存所有执行过的block</span></span><br><span class="line">ArrayList&lt;Pair&lt;Long, Capstone.CsInsn[]&gt;&gt; blocks=<span class="keyword">new</span> ArrayList&lt;Pair&lt;Long, Capstone.CsInsn[]&gt;&gt;();</span><br><span class="line">  <span class="comment">//主动调用目标函数</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">call_calckey</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//这里BlockHook就是按照一个block的触发</span></span><br><span class="line">      emulator.getBackend().hook_add_new(<span class="keyword">new</span> BlockHook() &#123;</span><br><span class="line">          <span class="meta">@Override</span></span><br><span class="line">          <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hook</span><span class="params">(Backend backend, <span class="keyword">long</span> address, <span class="keyword">int</span> size, Object user)</span> </span>&#123;</span><br><span class="line">                <span class="comment">//这里的insns是整个block。</span></span><br><span class="line">              Capstone.CsInsn[] insns = emulator.disassemble(address, size,<span class="number">0</span>);</span><br><span class="line">              blocks.add(<span class="keyword">new</span> Pair&lt;Long, Capstone.CsInsn[]&gt;(address,insns));</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;,<span class="number">0x4000F44C</span>,<span class="number">0x4000F44C</span>+<span class="number">0x330</span>,<span class="keyword">null</span>);</span><br><span class="line">      <span class="comment">//调用一个返回值为object的静态的jni函数</span></span><br><span class="line">      StringObject res = mainActivityDvm.callStaticJniMethodObject(emulator, <span class="string">&quot;stringFromJNI()Ljava/lang/String;&quot;</span>);</span><br><span class="line">      System.out.println(res.toString());</span><br><span class="line">      <span class="keyword">for</span>(Pair&lt;Long, Capstone.CsInsn[]&gt; block : blocks)&#123;</span><br><span class="line">          System.out.println(String.format(<span class="string">&quot;block address:0x%x&quot;</span>,block.getKey()) );</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>这样就将所有执行的block给保存了出来。其中保存的address就是块的第一个地址。后面我们连线到真实块。就是要直接跳到第一个地址。接下来筛选出所有的真实block。这里我的筛选比较简单。能满足我这个例子。其他比较复杂需要调整下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">        <span class="comment">//如果指令在队列中。则返回true。这是用来筛选block。如果block中有非以下指令的。说明很有可能是一个真实块</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">OpstrContains</span><span class="params">(String opstr)</span></span>&#123;</span><br><span class="line">        ArrayList&lt;String&gt; flags= <span class="keyword">new</span> ArrayList(Arrays.asList(<span class="string">&quot;ldur&quot;</span>,<span class="string">&quot;ldr&quot;</span>,<span class="string">&quot;str&quot;</span>,<span class="string">&quot;b&quot;</span>,<span class="string">&quot;movz&quot;</span>,<span class="string">&quot;movk&quot;</span>,<span class="string">&quot;cmp&quot;</span>,<span class="string">&quot;b.eq&quot;</span>));</span><br><span class="line">        <span class="keyword">if</span>(flags.contains(opstr))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">        <span class="comment">//存储所有真实的block块</span></span><br><span class="line">        ArrayList&lt;Pair&lt;Long, Capstone.CsInsn[]&gt;&gt; readlyBlock=<span class="keyword">new</span> ArrayList&lt;Pair&lt;Long, Capstone.CsInsn[]&gt;&gt;();</span><br><span class="line">        <span class="comment">//过滤出真实块</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">LoadReadlyAddress</span><span class="params">()</span></span>&#123;</span><br><span class="line">          <span class="comment">//第一个块肯定是要有的</span></span><br><span class="line">        readlyBlock.add(blocks.get(<span class="number">0</span>));</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;blocks.size();i++)&#123;</span><br><span class="line">            Pair&lt;Long, Capstone.CsInsn[]&gt; pdata=blocks.get(i);</span><br><span class="line">            Capstone.CsInsn[] insns=pdata.getValue();</span><br><span class="line">            Long address=pdata.getKey();</span><br><span class="line">            <span class="keyword">boolean</span> isReadly=<span class="keyword">false</span>;</span><br><span class="line">              <span class="comment">//遍历所有指令。检查出真实块。保存起来</span></span><br><span class="line">            <span class="keyword">for</span>(Capstone.CsInsn ins :insns)&#123;</span><br><span class="line">                <span class="keyword">if</span>(readlyBlock.contains(address))&#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>(!OpstrContains(ins.mnemonic))&#123;</span><br><span class="line">                    isReadly=<span class="keyword">true</span>;</span><br><span class="line">                    String opstr= ARM.assembleDetail(emulator,ins,address,<span class="keyword">false</span>,<span class="keyword">false</span>);</span><br><span class="line">                    System.out.println(String.format(<span class="string">&quot;block readly address:0x%x opstr:%s&quot;</span>,ins.address,opstr) );</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span>&#123;</span><br><span class="line"><span class="comment">//                    String opstr= ARM.assembleDetail(emulator,ins,address,false,false);</span></span><br><span class="line"><span class="comment">//                    System.out.println(String.format(&quot;block fla address:0x%x opstr:%s&quot;,ins.address,opstr) );</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(isReadly)&#123;</span><br><span class="line">                readlyBlock.add(<span class="keyword">new</span> Pair&lt;Long,Capstone.CsInsn[]&gt;(address,insns));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>获取到真实块之后。我们就需要进行跳转。首先处理我们的第一种关联方式。分支的关联方式比较复杂我们放的下面再说</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">                LoadReadlyAddress();</span><br><span class="line">        String modulePath=<span class="string">&quot;unidbg-android/src/test/resources/example_binaries/ollvm_fla/libnative-lib.so&quot;</span>;</span><br><span class="line">        <span class="keyword">byte</span>[] sodata=readFile(modulePath);</span><br><span class="line">        <span class="comment">//遍历真实块。然后直接修改成跳转真实块</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;readlyBlock.size();i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(i&lt;readlyBlock.size()-<span class="number">1</span>)&#123;</span><br><span class="line">                <span class="comment">//获取当前真实块</span></span><br><span class="line">                Pair&lt;Long, Capstone.CsInsn[]&gt;block=readlyBlock.get(i);</span><br><span class="line">                System.out.println(String.format(<span class="string">&quot;curBlock address:0x%x&quot;</span>,block.getKey()));</span><br><span class="line">                <span class="comment">//获取下一个真实块</span></span><br><span class="line">                Pair&lt;Long, Capstone.CsInsn[]&gt;nextBlock=readlyBlock.get(i+<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//取出当前真实块最后一个指令的地址</span></span><br><span class="line">                <span class="keyword">int</span> end_address= GetEndAddress(block.getValue()).intValue();</span><br><span class="line">                <span class="keyword">if</span>(end_address&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//获取下一个真实块第一个指令的地址</span></span><br><span class="line">                <span class="keyword">int</span> start_address=GetStartAddress(nextBlock.getValue()).intValue();</span><br><span class="line">                <span class="comment">//这里是最后跳转出结束的地方。由于已经被我们nop掉了循环。所以如果下一个块是跳转出while的。可以直接跳过了</span></span><br><span class="line">                <span class="keyword">if</span>(nextBlock.getKey().intValue()==<span class="number">0x4000f76c</span>)&#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">//准备转换汇编代码进行替换</span></span><br><span class="line">                <span class="keyword">try</span> (Keystone keystone = <span class="keyword">new</span> Keystone(KeystoneArchitecture.Arm64, KeystoneMode.LittleEndian)) &#123;</span><br><span class="line">                    <span class="keyword">int</span> subAddress=start_address-end_address;</span><br><span class="line">                    <span class="comment">//用来patch修改的asm指令。这里是要计算出当前地址的相对地址跳转。所以上面要减一下。</span></span><br><span class="line">                    String asmStr=String.format(<span class="string">&quot;b #0x%x&quot;</span>,subAddress);</span><br><span class="line">                    <span class="comment">//这个是我们显示日志看结果的。看看和我们之前手动分析的是不是差不多</span></span><br><span class="line">                    String showStr=String.format(<span class="string">&quot;b #0x%x&quot;</span>,start_address);</span><br><span class="line"><span class="comment">//                    System.out.println(String.format(&quot;address:0x%x chang asm:%s&quot;,end_address,showStr));</span></span><br><span class="line">                    <span class="comment">//转换汇编</span></span><br><span class="line">                    KeystoneEncoded encoded = keystone.assemble(asmStr);</span><br><span class="line">                    <span class="keyword">byte</span>[] patch = encoded.getMachineCode();</span><br><span class="line">                    <span class="keyword">if</span> (patch.length &lt;=<span class="number">0</span>) &#123;</span><br><span class="line">                        System.out.println(<span class="string">&quot;转换汇编失败&quot;</span>);</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"><span class="comment">//                    System.out.println(bytesToHexString(patch));</span></span><br><span class="line">                    <span class="comment">//替换原来的字节数据</span></span><br><span class="line">                    <span class="keyword">for</span>(<span class="keyword">int</span> y =<span class="number">0</span>;y&lt;patch.length;y++)&#123;</span><br><span class="line">                        sodata[end_address+y]=patch[y];</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//循环的地方给nop掉</span></span><br><span class="line">        <span class="keyword">byte</span>[] nop_byte=<span class="keyword">new</span> <span class="keyword">byte</span>[]&#123;<span class="number">0x1F</span>,<span class="number">0x20</span>,<span class="number">0x03</span>,(<span class="keyword">byte</span>)<span class="number">0xD5</span>&#125;;</span><br><span class="line">        <span class="keyword">int</span> nop_address=<span class="number">0xF778</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> y =<span class="number">0</span>;y&lt;nop_byte.length;y++)&#123;</span><br><span class="line">            sodata[nop_address+y]=nop_byte[y];</span><br><span class="line">        &#125;</span><br><span class="line">        String savepath=<span class="string">&quot;unidbg-android/src/test/resources/example_binaries/ollvm_fla/libnative-lib.patch.so&quot;</span>;</span><br><span class="line">        writeFile(sodata,savepath);</span><br><span class="line">        System.out.println(<span class="string">&quot;处理完成&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>然后看看日志。因为我们之前已经静态分析解混淆过一次了。所以结果我们是清楚的。那么下面的结果对比我们手动的答案要不同</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">address:0xf484 chang asm:b #0xf5f8</span><br><span class="line">address:0xf620 chang asm:b #0xf624</span><br><span class="line">address:0xf644 chang asm:b #0xf648</span><br><span class="line">address:0xf654 chang asm:b #0xf750</span><br><span class="line">address:0xf758 chang asm:b #0xf76c</span><br></pre></td></tr></table></figure>

<p>问题其实就是因为我们没有处理分支。只是单纯根据执行结果在跳转。那么这里我们需要判断一下csel来特殊处理一下。</p>
<p>需要处理的地方有两处。</p>
<p>1、分支的当前关联。也就是仿照我们手动关联时的cmp + b.eq + b来实现跳转两个地方</p>
<p>2、未执行分支的后续关联。手动关联是我们虽然不知道执行哪个分支。但是看v6的变化可以找到下一个真实块。但是自动化时。我们前面获取到的真实块。都是基于执行流程的。未执行部分的block块我们并未保存下来。所以我们要不就是一步步解析未执行分支的后续关联。要不就是直接修改分支判断的寄存器。把另一条分支的执行块也给记录下来。</p>
<p>我们先调整下hook部分的代码。将分支不同的执行块结果保存出来。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">                emulator.getBackend().hook_add_new(<span class="keyword">new</span> BlockHook() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hook</span><span class="params">(Backend backend, <span class="keyword">long</span> address, <span class="keyword">int</span> size, Object user)</span> </span>&#123;</span><br><span class="line">                <span class="comment">//这里的insns是整个block。</span></span><br><span class="line">                Capstone.CsInsn[] insns = emulator.disassemble(address, size,<span class="number">0</span>);</span><br><span class="line"><span class="comment">//                System.out.println(String.format(&quot;address:0x%x size:0x%x&quot;,address,insns.length));</span></span><br><span class="line">                <span class="keyword">if</span>(brance_data==<span class="number">0</span>)&#123;</span><br><span class="line">                    blocks.add(<span class="keyword">new</span> Pair&lt;Long, Capstone.CsInsn[]&gt;(address,insns));</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    branchBlocks.add(<span class="keyword">new</span> Pair&lt;Long, Capstone.CsInsn[]&gt;(address,insns));</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="number">0x4000F44C</span>,<span class="number">0x4000F778</span>,<span class="keyword">null</span>);</span><br><span class="line">        <span class="comment">//碰到csel的时候把w8的值修改下。控制走其他分支</span></span><br><span class="line">        emulator.getBackend().hook_add_new(<span class="keyword">new</span> CodeHook() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hook</span><span class="params">(Backend backend, <span class="keyword">long</span> address, <span class="keyword">int</span> size, Object user)</span> </span>&#123;</span><br><span class="line">                <span class="comment">//这里的insns是整个block。</span></span><br><span class="line">                Capstone.CsInsn[] insns = emulator.disassemble(address, size,<span class="number">0</span>);</span><br><span class="line">                <span class="keyword">for</span>(Capstone.CsInsn ins :insns)&#123;</span><br><span class="line">                    <span class="comment">//这里就是控制如果brance_data为0就固定走第一个分支。为1就固定走第二个分支</span></span><br><span class="line">                    <span class="keyword">if</span>(ins.mnemonic.equals(<span class="string">&quot;csel&quot;</span>))&#123;</span><br><span class="line">                        <span class="keyword">int</span> w9=emulator.getBackend().reg_read(Arm64Const.UC_ARM64_REG_W9).intValue();</span><br><span class="line">                        <span class="keyword">int</span> w10=emulator.getBackend().reg_read(Arm64Const.UC_ARM64_REG_W10).intValue();</span><br><span class="line">                        <span class="keyword">if</span>(brance_data==<span class="number">0</span>)&#123;</span><br><span class="line">                            emulator.getBackend().reg_write(Arm64Const.UC_ARM64_REG_W10,w9);</span><br><span class="line">                        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                            emulator.getBackend().reg_write(Arm64Const.UC_ARM64_REG_W9,w10);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="number">0x4000F44C</span>,<span class="number">0x4000F778</span>,<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//调用一个返回值为object的静态的jni函数</span></span><br><span class="line">        StringObject res = mainActivityDvm.callStaticJniMethodObject(emulator, <span class="string">&quot;stringFromJNI()Ljava/lang/String;&quot;</span>);</span><br><span class="line">        System.out.println(res.toString());</span><br><span class="line">        brance_data=<span class="number">1</span>;</span><br><span class="line">        StringObject res2 = mainActivityDvm.callStaticJniMethodObject(emulator, <span class="string">&quot;stringFromJNI()Ljava/lang/String;&quot;</span>);</span><br><span class="line">        System.out.println(res2.toString());</span><br><span class="line">        LoadReadlyAddress();</span><br></pre></td></tr></table></figure>

<p>然后就可以在跳转的地方获取到两个跳转的真实块地址了。然后打上patch替换掉原来的三行汇编</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">                                <span class="comment">//获取当前块中的csel地址。如果没有csel则为0</span></span><br><span class="line">                Long cselAddress=GetCselddress(block.getValue());</span><br><span class="line">                <span class="comment">//存在csel指令说明是有分支。然后要特殊处理</span></span><br><span class="line">                <span class="keyword">if</span>(cselAddress&gt;<span class="number">0</span>)&#123;</span><br><span class="line">                    <span class="comment">//获取另一个分支的下一个真实块</span></span><br><span class="line">                    <span class="keyword">int</span> start_address2=GetBranchReadlyAddress(block.getKey());</span><br><span class="line">                    <span class="keyword">try</span> (Keystone keystone = <span class="keyword">new</span> Keystone(KeystoneArchitecture.Arm64, KeystoneMode.LittleEndian))&#123;</span><br><span class="line">                        <span class="comment">/*</span></span><br><span class="line"><span class="comment">                        *要改以下三行的汇编。前面获取出来的cselAddress是CSEL的地址。</span></span><br><span class="line"><span class="comment">                        * TST             W8, #1</span></span><br><span class="line"><span class="comment">                        * CSEL            W8, W9, W10, NE</span></span><br><span class="line"><span class="comment">                        * STR             W8, [SP,#0x50+var_2C]</span></span><br><span class="line"><span class="comment">                        * */</span></span><br><span class="line">                        <span class="keyword">int</span> subAddress1=start_address-(cselAddress.intValue())+<span class="number">4</span>;</span><br><span class="line">                        <span class="keyword">int</span> subAddress2=start_address2-(cselAddress.intValue())+<span class="number">4</span>;</span><br><span class="line">                        String asm1=<span class="string">&quot;cmp w8,#0x1&quot;</span>;</span><br><span class="line">                        String showAsm1=String.format(<span class="string">&quot;b.eq 0x%x&quot;</span>,start_address);</span><br><span class="line">                        String showAsm2=String.format(<span class="string">&quot;b #0x%x&quot;</span>,start_address2);</span><br><span class="line"><span class="comment">//                        System.out.println(String.format(&quot;address:0x%x chang asm1:%s&quot;,cselAddress,showAsm1));</span></span><br><span class="line"><span class="comment">//                        System.out.println(String.format(&quot;address:0x%x chang asm2:%s&quot;,cselAddress,showAsm2));</span></span><br><span class="line">                        String asm2=String.format(<span class="string">&quot;b.eq 0x%x&quot;</span>,subAddress1);</span><br><span class="line">                        String asm3=String.format(<span class="string">&quot;b 0x%x&quot;</span>,subAddress2);</span><br><span class="line">                        <span class="comment">//转换汇编</span></span><br><span class="line">                        KeystoneEncoded encoded = keystone.assemble(Arrays.asList(asm1,asm2,asm3));</span><br><span class="line">                        <span class="keyword">byte</span>[] patch = encoded.getMachineCode();</span><br><span class="line">                        <span class="keyword">if</span> (patch.length &lt;=<span class="number">0</span>) &#123;</span><br><span class="line">                            System.out.println(<span class="string">&quot;转换汇编失败&quot;</span>);</span><br><span class="line">                            <span class="keyword">return</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        System.out.println(bytesToHexString(patch));</span><br><span class="line">                        <span class="comment">//这里去掉基址。再往上一个指令的位置开始写入</span></span><br><span class="line">                        <span class="keyword">int</span> replace_address=cselAddress.intValue()-<span class="number">4</span>;</span><br><span class="line">                        <span class="comment">//替换原来的字节数据</span></span><br><span class="line">                        <span class="keyword">for</span>(<span class="keyword">int</span> y =<span class="number">0</span>;y&lt;patch.length;y++)&#123;</span><br><span class="line">                            sodata[replace_address+y]=patch[y];</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br></pre></td></tr></table></figure>

<p>贴上执行完成后解析的结果</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">__int64 __usercall calcKey@&lt;X0&gt;(__int64 a1@&lt;X0&gt;, __int64 a2@&lt;X8&gt;)</span><br><span class="line">&#123;</span><br><span class="line">  __int64 v2; <span class="comment">// x0</span></span><br><span class="line">  __int64 v4; <span class="comment">// [xsp+10h] [xbp-40h]</span></span><br><span class="line">  __int64 v5; <span class="comment">// [xsp+18h] [xbp-38h]</span></span><br><span class="line"></span><br><span class="line">  v5 = a2;</span><br><span class="line">  v4 = a1;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int64)sub_F77C(a1) &gt; <span class="number">0xA</span> == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    sub_F830(v4, <span class="string">&quot;ceshi&quot;</span>);</span><br><span class="line">    v2 = sub_F8E4(v5, v4);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v2 = sub_F77C(v4);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> sub_F77C(v2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对比之前我们手动还原的结果看了下。还是差了点。但是当前的执行流程的反混淆结果可以看了。未执行部分的分支如何去关联我想了好久越想越复杂了。就没有继续倒腾了。有知道的大佬麻烦提点下。</p>
<p>中间还有一些细节处理的地方没有贴代码，我就直接丢上地址了。代码我都尽量写上注释了。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/dqzg12300/unidbg_tools.git">https://github.com/dqzg12300/unidbg_tools.git</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">king</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://missking.cc/2021/05/14/ollvm3/">http://missking.cc/2021/05/14/ollvm3/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://missking.cc" target="_blank">king的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%8F%8D%E6%B7%B7%E6%B7%86/">反混淆</a></div><div class="post_share"><div class="social-share" data-image="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/06/03/android1/"><img class="prev-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">android基础篇一（笔记）</div></div></a></div><div class="next-post pull-right"><a href="/2021/05/04/ollvm2/"><img class="next-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">使用unidbg去ollvm虚假分支反混淆</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2021/05/04/ollvm2/" title="使用unidbg去ollvm虚假分支反混淆"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-05-04</div><div class="title">使用unidbg去ollvm虚假分支反混淆</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div><div id="comment-switch"><span class="first-comment">Valine</span><span class="switch-btn"></span><span class="second-comment">Disqus</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div><div><div id="disqus_thread"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/assets/blogImg/litten.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">king</div><div class="author-info__description"></div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">36</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">16</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/dqzg12300"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/dqzg12300" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:king910827@163.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">新时代农民工</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF%EF%BC%9A%E5%85%88%E5%B0%84%E7%AE%AD%E5%90%8E%E7%94%BB%E9%9D%B6"><span class="toc-number">1.</span> <span class="toc-text">思路：先射箭后画靶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E6%89%8B%E5%8A%A8%E8%BF%98%E5%8E%9F"><span class="toc-number">2.</span> <span class="toc-text">一、手动还原</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E8%87%AA%E5%8A%A8%E5%8C%96%E5%8F%8D%E6%B7%B7%E6%B7%86"><span class="toc-number">3.</span> <span class="toc-text">二、自动化反混淆</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/09/05/kernel1-0/" title="aosp12内核编译开启硬件断点和kprobes记录">aosp12内核编译开启硬件断点和kprobes记录</a><time datetime="2022-09-05T13:01:17.000Z" title="发表于 2022-09-05 13:01:17">2022-09-05</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/04/11/Kernel1/" title="linux内核书籍阅读笔记1">linux内核书籍阅读笔记1</a><time datetime="2022-04-11T22:38:34.000Z" title="发表于 2022-04-11 22:38:34">2022-04-11</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/03/20/CPU%E5%9F%BA%E7%A1%80/" title="逆向工程权威指南的看书笔记">逆向工程权威指南的看书笔记</a><time datetime="2022-03-20T15:38:13.000Z" title="发表于 2022-03-20 15:38:13">2022-03-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/01/27/MikRom/" title="FartExt超进化之奇奇怪怪的新ROM工具MikRom">FartExt超进化之奇奇怪怪的新ROM工具MikRom</a><time datetime="2022-01-27T13:48:38.000Z" title="发表于 2022-01-27 13:48:38">2022-01-27</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2021/07/26/fartext/" title="FartExt之优化更深主动调用的FART10">FartExt之优化更深主动调用的FART10</a><time datetime="2021-07-26T21:31:05.000Z" title="发表于 2021-07-26 21:31:05">2021-07-26</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By king</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">本地搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'ihIPa0lRcHcfVzXqcboVznyu-gzGzoHsz',
      appKey: 'YB8y22BOhfzrVioINMUoEqxd',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !true) {
  if (true) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script><script>function loadDisqus () {
  var disqus_config = function () {
    this.page.url = 'http://missking.cc/2021/05/14/ollvm3/'
    this.page.identifier = '2021/05/14/ollvm3/'
    this.page.title = '使用unidbg还原标准ollvm的fla控制流程平坦化'
  };

  window.disqusReset = () => {
    DISQUS.reset({
      reload: true,
      config: disqus_config
    })
  }

  if (window.DISQUS) disqusReset()
  else {
    (function() { 
      var d = document, s = d.createElement('script');
      s.src = 'https://.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  }
}

if ('Valine' === 'Disqus' || !true) {
  if (true) btf.loadComment(document.getElementById('disqus_thread'), loadDisqus)
  else loadDisqus()
} else {
  function loadOtherComment () {
    loadDisqus()
  }
}
</script></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-nest.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>