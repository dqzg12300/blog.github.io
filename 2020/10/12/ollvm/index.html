<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>ollvm自定义string加密pass | king的博客</title><meta name="keywords" content="基础"><meta name="author" content="king"><meta name="copyright" content="king"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="先贴上测试好的结果: https:&#x2F;&#x2F;github.com&#x2F;dqzg12300&#x2F;kOLLVM.git 想要写一个字符串加密的pass，第一步就是先实现一遍c++的算法流程，然后再看一看生成的IR文件，然后再写对应的加密pass，下面看一个自己实现的简单c++字符串加密。 1234567891011121314151617181920212223242526272829303132333435363">
<meta property="og:type" content="article">
<meta property="og:title" content="ollvm自定义string加密pass">
<meta property="og:url" content="http://missking.cc/2020/10/12/ollvm/index.html">
<meta property="og:site_name" content="king的博客">
<meta property="og:description" content="先贴上测试好的结果: https:&#x2F;&#x2F;github.com&#x2F;dqzg12300&#x2F;kOLLVM.git 想要写一个字符串加密的pass，第一步就是先实现一遍c++的算法流程，然后再看一看生成的IR文件，然后再写对应的加密pass，下面看一个自己实现的简单c++字符串加密。 1234567891011121314151617181920212223242526272829303132333435363">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
<meta property="article:published_time" content="2020-10-12T20:00:48.000Z">
<meta property="article:modified_time" content="2022-09-05T12:58:31.041Z">
<meta property="article:author" content="king">
<meta property="article:tag" content="基础">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://missking.cc/2020/10/12/ollvm/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'ollvm自定义string加密pass',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: false,
  postUpdate: '2022-09-05 12:58:31'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.0.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/assets/blogImg/litten.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">36</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">16</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/contact/"><i class="fa-fw fas fa-comment-dots"></i><span> 留言板</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">king的博客</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/contact/"><i class="fa-fw fas fa-comment-dots"></i><span> 留言板</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">ollvm自定义string加密pass</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-10-12T20:00:48.000Z" title="发表于 2020-10-12 20:00:48">2020-10-12</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-09-05T12:58:31.041Z" title="更新于 2022-09-05 12:58:31">2022-09-05</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/ollve/">ollve</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="ollvm自定义string加密pass"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>先贴上测试好的结果: <a target="_blank" rel="noopener" href="https://github.com/dqzg12300/kOLLVM.git">https://github.com/dqzg12300/kOLLVM.git</a></p>
<p>想要写一个字符串加密的pass，第一步就是先实现一遍c++的算法流程，然后再看一看生成的IR文件，然后再写对应的加密pass，下面看一个自己实现的简单c++字符串加密。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span>  argc, <span class="keyword">char</span>** argv)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//加密</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> str1=<span class="string">&quot;hello world!!!&quot;</span>;</span><br><span class="line">    <span class="comment">//这里是随机的key，先写固定,真实实现的时候再每个字节使用一个随机key</span></span><br><span class="line">    <span class="keyword">int</span> randkey=<span class="number">11</span>;</span><br><span class="line">      <span class="comment">//加密复杂度</span></span><br><span class="line">    <span class="keyword">int</span> kstr_size=<span class="number">10</span>;</span><br><span class="line">    <span class="keyword">int</span> enclen=randkey+kstr_size;</span><br><span class="line">    <span class="keyword">char</span> encres[str1.<span class="built_in">size</span>()];</span><br><span class="line">    <span class="keyword">int</span> idx=<span class="number">0</span>;</span><br><span class="line">    <span class="built_in">memset</span>(encres,<span class="number">0</span>,enclen);</span><br><span class="line">    <span class="comment">//这里大概就是遍历字符串，每个字符根据加密复杂度进行一定数量迭代异或，最后一次的迭代使用取反再异或</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;str1.<span class="built_in">size</span>();i++)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;cur: %x \r\n&quot;</span>,str1[i]);</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> y=randkey;y&lt;enclen;y++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(y==randkey)&#123;</span><br><span class="line">                encres[i]=str1[i]^y;</span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(y==enclen<span class="number">-1</span>)&#123;</span><br><span class="line">                encres[i]=encres[i]^(~y);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                encres[i]=encres[i]^y;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%x &quot;</span>,encres[i]);</span><br><span class="line">            idx++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;encdata: %s\r\n&quot;</span>,encres);</span><br><span class="line">    <span class="comment">//下面是解密函数</span></span><br><span class="line">    <span class="keyword">char</span> decres[str1.<span class="built_in">size</span>()];</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;str1.<span class="built_in">size</span>();i++)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;cur enc: %x \r\n&quot;</span>,encres[i]);</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> y=enclen<span class="number">-1</span>;y&gt;=randkey;y--)&#123;</span><br><span class="line">            <span class="keyword">if</span>(y==enclen<span class="number">-1</span>)&#123;</span><br><span class="line">                decres[i]=encres[i]^(~y);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                decres[i]=decres[i]^y;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%x &quot;</span>,decres[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;res: %s\r\n&quot;</span>,decres);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个简单加密的意思，就是根据复杂度参数。来进行一定次数的迭代，将当前字符每次都异或一下，最后一次是先去反，再异或，解密就是反之。测试结果能正常加密和解密后，我们就先输出一份ir文件。看看在ir中间语言中是如何进行加密和解密的。</p>
<a id="more"></a>

<p><code>clang -emit-llvm -S main.cpp -o main.ll</code></p>
<p>生成好对应的ir文件后，我们开始写这个加密pass，然后再写的过程中，根据逻辑需要，去ir中找对应的指令处理方式</p>
<p>在ir文件中的层级划分:Module(模块)的下一层是若干Function(函数),然后在Function的下一层是若干BasicBlock(基本快),再BasicBlock的下一层是若干Instruction(指令块)</p>
<p>现在准备就绪，下面开始先准备一个加密的pass,基本代码如下</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;kllvm/Transforms/Obfuscation/Utils.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;kllvm/Transforms/Obfuscation/KStringEncode.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> llvm;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">      <span class="comment">//加密复杂度</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> defaultKStringSize = <span class="number">0x10</span>;</span><br><span class="line">    <span class="keyword">static</span> cl::opt&lt;<span class="keyword">int</span>&gt;</span><br><span class="line">            KStringSize(<span class="string">&quot;kstr_size&quot;</span>, cl::desc(<span class="string">&quot;Choose the probability [%] each basic blocks will be obfuscated by the -kstr pass&quot;</span>), cl::value_desc(<span class="string">&quot;king string encode Encryption length&quot;</span>), cl::init(defaultKStringSize), cl::Optional);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">KStringEncode</span>:</span> <span class="keyword">public</span> FunctionPass&#123;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">char</span> ID; <span class="comment">// Pass identification</span></span><br><span class="line">        <span class="keyword">bool</span> flag;</span><br><span class="line">        KStringEncode() : FunctionPass(ID) &#123;&#125;</span><br><span class="line">        KStringEncode(<span class="keyword">bool</span> flag) : FunctionPass(ID) &#123;<span class="keyword">this</span>-&gt;flag = flag; KStringEncode();&#125;</span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">runOnFunction</span><span class="params">(Function &amp;F)</span></span>&#123;</span><br><span class="line">              <span class="comment">//先检查加密复杂度是否在合法范围</span></span><br><span class="line">            <span class="keyword">if</span> ( !((KStringSize &gt; <span class="number">0</span>) &amp;&amp; (KStringSize &lt;= <span class="number">100</span>)) ) &#123;</span><br><span class="line">                errs()&lt;&lt;<span class="string">&quot;KStringEncode application basic blocks percentage -kstr_size=x must be 0 &lt; x &lt;= 100&quot;</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(toObfuscate(flag,&amp;F,<span class="string">&quot;kstr&quot;</span>)) &#123;</span><br><span class="line">                kstr(F);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">kstr</span><span class="params">(Function&amp; func)</span></span>&#123;</span><br><span class="line">            <span class="comment">//todo 这里再写具体的pass逻辑</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">char</span> KStringEncode::ID = <span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> RegisterPass&lt;KStringEncode&gt; <span class="title">X</span><span class="params">(<span class="string">&quot;kstr&quot;</span>, <span class="string">&quot;inserting bogus control flow&quot;</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">Pass *<span class="title">llvm::createKStringEncode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> KStringEncode();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Pass *<span class="title">llvm::createKStringEncode</span><span class="params">(<span class="keyword">bool</span> flag)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> KStringEncode(flag);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里准备好了pass的基本代码后，最后就剩下最重要的核心逻辑，如何把c++的加密方式。在pass中实现，我们的功能是实现字符串加密，那么第一步应该是取得这个函数中的全部字符串，那么我们先看看ir中字符串的特征</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@.str &#x3D; private unnamed_addr constant [15 x i8] c&quot;hello world!!!\00&quot;, align 1</span><br></pre></td></tr></table></figure>

<p>可以看到，这个str是一个操作数，想要获取全部字符串，就得先遍历所有指令块中的操作数。然后再根据字符串的特征来进行过滤。下面先看如何遍历所有指令块。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">kstr</span><span class="params">(Function&amp; func)</span></span>&#123;</span><br><span class="line">            <span class="keyword">for</span>(BasicBlock&amp; bb:func)&#123;</span><br><span class="line">                <span class="keyword">for</span>(Instruction&amp; ins :bb)&#123;</span><br><span class="line">                    <span class="keyword">for</span>(Value* val:ins.operands())&#123;</span><br><span class="line">                        Value* stripOp=val-&gt;stripPointerCasts();</span><br><span class="line">                        <span class="keyword">if</span>(stripOp-&gt;getName().contains(<span class="string">&quot;.str&quot;</span>))&#123;</span><br><span class="line">                            errs()&lt;&lt;ins&lt;&lt;<span class="string">&quot;\n&quot;</span>;</span><br><span class="line">                            errs()&lt;&lt;*val&lt;&lt;<span class="string">&quot;\n&quot;</span>;</span><br><span class="line">                            errs()&lt;&lt;*stripOp&lt;&lt;<span class="string">&quot;\n&quot;</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>上面遍历了函数中的所有基本快，然后遍历所有指令块，然后遍历所有操作数，然后获取操作数的值，判断该操作数是否是一个字符串，并且打印这个指令块，操作数，以及取到的操作数的值，下面看看打印的结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">  store i8* getelementptr inbounds ([7 x i8], [7 x i8]* @.str, i64 0, i64 0), i8** %str, align 8</span><br><span class="line">i8* getelementptr inbounds ([7 x i8], [7 x i8]* @.str, i64 0, i64 0)</span><br><span class="line">@.str &#x3D; private unnamed_addr constant [7 x i8] c&quot;kanxue\00&quot;, align 1</span><br></pre></td></tr></table></figure>

<p>那么看到了，我们想获取的字符串是在stripOp中。那么接下来就把所有字符串全部获取出来并转换成string</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//封装一个转换操作数值为字符串的函数</span></span><br><span class="line"><span class="function"><span class="built_in">std</span>::<span class="built_in">string</span> <span class="title">ConvertOpToString</span><span class="params">(Value* op)</span></span>&#123;</span><br><span class="line">            GlobalVariable* globalVar= dyn_cast&lt;GlobalVariable&gt;(op);</span><br><span class="line">            <span class="keyword">if</span>(!globalVar)&#123;</span><br><span class="line">                errs()&lt;&lt;<span class="string">&quot;dyn cast gloabl err&quot;</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ConstantDataSequential* cds=dyn_cast&lt;ConstantDataSequential&gt;(globalVar-&gt;getInitializer());</span><br><span class="line">            <span class="keyword">if</span>(!cds)&#123;</span><br><span class="line">                errs()&lt;&lt;<span class="string">&quot;dyn cast constant data err&quot;</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> cds-&gt;getRawDataValues();;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">kstr</span><span class="params">(Function&amp; func)</span></span>&#123;</span><br><span class="line">            <span class="keyword">for</span>(BasicBlock&amp; bb:func)&#123;</span><br><span class="line">                <span class="keyword">for</span>(Instruction&amp; ins :bb)&#123;</span><br><span class="line">                    <span class="keyword">for</span>(Value* val:ins.operands())&#123;</span><br><span class="line">                        Value* stripOp=val-&gt;stripPointerCasts();</span><br><span class="line">                        <span class="keyword">if</span>(stripOp-&gt;getName().contains(<span class="string">&quot;.str&quot;</span>))&#123;</span><br><span class="line">                            <span class="built_in">std</span>::<span class="built_in">string</span> strdata=ConvertOpToString(stripOp);</span><br><span class="line">                            errs()&lt;&lt;strdata&lt;&lt;<span class="string">&quot;\n&quot;</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>之前看到的字符串的ir代码看到所有字符串都是全局的，所以要先转换成全局的对象，然后再转换成数值。然后看这里的打印结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kanxue</span><br><span class="line">hello ollvm:%d</span><br></pre></td></tr></table></figure>

<p>获取到所有的字符串了之后。接下来。我们要先把这个字符串加密，然后再用插入指令块来进行解密。下面继续完善，先把之前搞好的加密算法迁移进来。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//转换字符串</span></span><br><span class="line">        <span class="function"><span class="built_in">std</span>::<span class="built_in">string</span> <span class="title">ConvertOpToString</span><span class="params">(Value* op)</span></span>&#123;</span><br><span class="line">            GlobalVariable* globalVar= dyn_cast&lt;GlobalVariable&gt;(op);</span><br><span class="line">            <span class="keyword">if</span>(!globalVar)&#123;</span><br><span class="line">                errs()&lt;&lt;<span class="string">&quot;dyn cast gloabl err&quot;</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ConstantDataSequential* cds=dyn_cast&lt;ConstantDataSequential&gt;(globalVar-&gt;getInitializer());</span><br><span class="line">            <span class="keyword">if</span>(!cds)&#123;</span><br><span class="line">                errs()&lt;&lt;<span class="string">&quot;dyn cast constant data err&quot;</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> cds-&gt;getRawDataValues();;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">kstr</span><span class="params">(Function&amp; func)</span></span>&#123;</span><br><span class="line">            <span class="keyword">for</span>(BasicBlock&amp; bb:func)&#123;</span><br><span class="line">                <span class="keyword">for</span>(Instruction&amp; ins :bb)&#123;</span><br><span class="line">                    <span class="keyword">for</span>(Value* val:ins.operands())&#123;</span><br><span class="line">                        Value* stripOp=val-&gt;stripPointerCasts();</span><br><span class="line">                        <span class="keyword">if</span>(stripOp-&gt;getName().contains(<span class="string">&quot;.str&quot;</span>))&#123;</span><br><span class="line">                            <span class="built_in">std</span>::<span class="built_in">string</span> strdata=ConvertOpToString(stripOp);</span><br><span class="line">                            errs()&lt;&lt;strdata&lt;&lt;<span class="string">&quot;\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">                            <span class="comment">//加密流程</span></span><br><span class="line">                            <span class="keyword">uint8_t</span> keys[strdata.<span class="built_in">size</span>()];</span><br><span class="line">                            <span class="keyword">char</span> encres[strdata.<span class="built_in">size</span>()];</span><br><span class="line">                            <span class="keyword">int</span> idx=<span class="number">0</span>;</span><br><span class="line">                            <span class="built_in">memset</span>(encres,<span class="number">0</span>,strdata.<span class="built_in">size</span>());</span><br><span class="line">                            <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;strdata.<span class="built_in">size</span>();i++)&#123;</span><br><span class="line">                                <span class="keyword">uint8_t</span> randkey=llvm::cryptoutils-&gt;<span class="keyword">get_uint8_t</span>();</span><br><span class="line">                                keys[i]=randkey;</span><br><span class="line">                                <span class="keyword">int</span> enclen=randkey+defaultKStringSize;</span><br><span class="line">                                <span class="keyword">for</span>(<span class="keyword">int</span> y=randkey;y&lt;enclen;y++)&#123;</span><br><span class="line">                                    <span class="keyword">if</span>(y==randkey)&#123;</span><br><span class="line">                                        encres[i]=strdata[i]^y;</span><br><span class="line">                                    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(y==enclen<span class="number">-1</span>)&#123;</span><br><span class="line">                                        encres[i]=encres[i]^(~y);</span><br><span class="line">                                    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                                        encres[i]=encres[i]^y;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    idx++;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>这里大致流程和之前一样。只是key我们装起来了。然后每个字节处理都随机一次key。接下来的处理就是插入指令块来对这个加密数据encres进行解密还原处理。</p>
<p>我们想要处理这个加密的数据，首先要先创建一个内存指令，来存放这个加密后的数据。然后再对加密后的数据遍历。进行还原。所以，我们的下一步先创建一个BitCastInst。并且我们需要用一个int8的array来给这个内存指令进行赋值。下面的代码是先创建array指令，然后用array指令创建一个内存指令</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ArrayType* arrType=ArrayType::<span class="built_in">get</span>(Type::getInt8Ty(func.getContext()),strdata.<span class="built_in">size</span>());</span><br><span class="line">                            AllocaInst* arrayInst=<span class="keyword">new</span> AllocaInst(arrType,<span class="number">0</span>,<span class="literal">nullptr</span>,<span class="number">1</span>,Twine(stripOp-&gt;getName()+<span class="string">&quot;.arr&quot;</span>),&amp;ins);</span><br><span class="line">                            BitCastInst* bitInst=<span class="keyword">new</span> BitCastInst(arrayInst,Type::getInt8PtrTy(func.getParent()-&gt;getContext()),Twine(stripOp-&gt;getName()+<span class="string">&quot;bitcast&quot;</span>),&amp;ins);</span><br></pre></td></tr></table></figure>

<p>上面的就是先创建一个int8的array类型，然后用这个类型创建一个array，然后再用这个array创建内存指令，这些指令都插入在遍历到字符串指令的当前行的前方。这个bitcast将用来存放加密后的字符串数据</p>
<p>接下来就是解密的逻辑处理。和我们之前c++的流程一样，只不过这里需要换成插入指令块的形式来进行加密数据的还原，我直接贴上解密的代码部分，然后里面有详细的注释。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">ArrayType* arrType=ArrayType::<span class="built_in">get</span>(Type::getInt8Ty(func.getContext()),strdata.<span class="built_in">size</span>());</span><br><span class="line">AllocaInst* arrayInst=<span class="keyword">new</span> AllocaInst(arrType,<span class="number">0</span>,<span class="literal">nullptr</span>,<span class="number">1</span>,Twine(stripOp-&gt;getName()+<span class="string">&quot;.arr&quot;</span>),&amp;ins);</span><br><span class="line">BitCastInst* bitInst=<span class="keyword">new</span> BitCastInst(arrayInst,Type::getInt8PtrTy(func.getParent()-&gt;getContext()),Twine(stripOp-&gt;getName()+<span class="string">&quot;.bitcast&quot;</span>),&amp;ins);</span><br><span class="line"><span class="comment">//创建一个对象用来存放当前加密字节解密时每次异或的结果</span></span><br><span class="line">AllocaInst* eor_res=<span class="keyword">new</span> AllocaInst(Type::getInt8Ty(func.getContext()),<span class="number">0</span>,<span class="literal">nullptr</span>,<span class="number">1</span>,Twine(stripOp-&gt;getName()+<span class="string">&quot;.alloc.res&quot;</span>),&amp;ins);</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;strdata.<span class="built_in">size</span>();i++)&#123;</span><br><span class="line">    <span class="keyword">uint8_t</span> randkey=keys[i];</span><br><span class="line">    <span class="keyword">int</span> enclen=randkey+defaultKStringSize;</span><br><span class="line">    ConstantInt* enc_const=ConstantInt::<span class="built_in">get</span>(Type::getInt8Ty(func.getContext()),encres[i]);</span><br><span class="line">    <span class="comment">//用来存放解密结果的bitcat</span></span><br><span class="line">    ConstantInt* i_const=ConstantInt::<span class="built_in">get</span>(Type::getInt8Ty(func.getContext()),i);</span><br><span class="line">    GetElementPtrInst* element=GetElementPtrInst::CreateInBounds(bitInst,i_const);</span><br><span class="line">    element-&gt;insertBefore(&amp;ins);</span><br><span class="line">    StoreInst* last_store=<span class="literal">nullptr</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> y=enclen<span class="number">-1</span>;y&gt;=randkey;y--)&#123;</span><br><span class="line">        <span class="comment">/*下面是获取y的指令块*/</span></span><br><span class="line">        <span class="comment">//先是创建一个数值y</span></span><br><span class="line">        ConstantInt *eor_data = ConstantInt::<span class="built_in">get</span>(Type::getInt8Ty(func.getContext()),y);</span><br><span class="line">        <span class="comment">//申请一个int8的内存来存放数值y</span></span><br><span class="line">        AllocaInst* eor_alloc=<span class="keyword">new</span> AllocaInst(Type::getInt8Ty(func.getContext()),<span class="number">0</span>,<span class="literal">nullptr</span>,<span class="number">1</span>,Twine(stripOp-&gt;getName()+<span class="string">&quot;.alloc.y&quot;</span>),&amp;ins);</span><br><span class="line">        <span class="comment">//将数值y赋值给申请的内存空间</span></span><br><span class="line">        StoreInst* store_eor=<span class="keyword">new</span> StoreInst(eor_data,eor_alloc);</span><br><span class="line">        store_eor-&gt;insertAfter(eor_alloc);</span><br><span class="line">        <span class="comment">//从内存空间中加载里面的数值y</span></span><br><span class="line">        LoadInst* eor_load=<span class="keyword">new</span> LoadInst(eor_alloc,<span class="string">&quot;&quot;</span>);</span><br><span class="line">        eor_load-&gt;insertAfter(store_eor);</span><br><span class="line">        <span class="comment">//如果是第一次异或</span></span><br><span class="line">        <span class="keyword">if</span>(y==enclen<span class="number">-1</span>)&#123;</span><br><span class="line">            <span class="comment">//然后进行取反计算</span></span><br><span class="line">            BinaryOperator* binNotOp=BinaryOperator::CreateNot(eor_load);</span><br><span class="line">            binNotOp-&gt;insertAfter(eor_load);</span><br><span class="line">              <span class="comment">//然后异或</span></span><br><span class="line">            BinaryOperator* binXorOp=BinaryOperator::CreateXor(enc_const,binNotOp);</span><br><span class="line">            binXorOp-&gt;insertAfter(binNotOp);</span><br><span class="line">            <span class="comment">//将加密字节设置为上次异或的结果</span></span><br><span class="line">            StoreInst* store_eor_res=<span class="keyword">new</span> StoreInst(binXorOp,eor_res);</span><br><span class="line">            store_eor_res-&gt;insertAfter(store_data);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">//加载获取上次异或的结果</span></span><br><span class="line">            LoadInst* eor_load_res=<span class="keyword">new</span> LoadInst(eor_res,stripOp-&gt;getName()+<span class="string">&quot;.load&quot;</span>);</span><br><span class="line">            eor_load_res-&gt;insertAfter(store_eor);</span><br><span class="line">            <span class="comment">//然后再进行异或计算</span></span><br><span class="line">            BinaryOperator* binXorOp=BinaryOperator::CreateXor(eor_load_res,eor_load);</span><br><span class="line">            binXorOp-&gt;insertAfter(eor_load);</span><br><span class="line">            <span class="comment">//将计算后的结果存放回数组中</span></span><br><span class="line">            StoreInst* store_data=<span class="keyword">new</span> StoreInst(binXorOp,eor_res);</span><br><span class="line">            store_data-&gt;insertAfter(binXorOp);</span><br><span class="line">            <span class="comment">//当循环到最后一次时，获取一下最后一次赋值的指令块地址。方便后面接着往后插指令块</span></span><br><span class="line">            <span class="keyword">if</span>(y==randkey)&#123;</span><br><span class="line">                last_store=store_data;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">      <span class="comment">//读取这个字节经过多次异或后的最终结果</span></span><br><span class="line">    LoadInst* dec_res=<span class="keyword">new</span> LoadInst(eor_res,stripOp-&gt;getName()+<span class="string">&quot;.dec.res&quot;</span>);</span><br><span class="line">    dec_res-&gt;insertAfter(last_store);</span><br><span class="line">    <span class="comment">//将这个结果写入到前面用来存放的解密结果bitcat处</span></span><br><span class="line">    StoreInst* store_data=<span class="keyword">new</span> StoreInst(dec_res,element);</span><br><span class="line">    store_data-&gt;insertAfter(dec_res);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>上面就是把c++的解密流程用插入指令块的方式实现的方式。流程比较繁琐，但是大概意思是差不多的。</p>
<p>最后这里完成后，我们就可以删除指令块中的字符串明文部分。然后只保留密文</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//将字符串操作数替换为我们准备好的解密结果的bitInst</span></span><br><span class="line">val-&gt;replaceAllUsesWith(bitInst);</span><br><span class="line"><span class="comment">//然后再删掉之前我们获取到的字符串的明文部分。这样就只有密文数据和密文解密的流程，最后动态执行拿到解密字符串了</span></span><br><span class="line">GlobalVariable* globalVar= dyn_cast&lt;GlobalVariable&gt;(stripOp);</span><br><span class="line">globalVar-&gt;eraseFromParent();</span><br></pre></td></tr></table></figure>

<p>到这里整个流程就完成了。这里还有一个点需要注意的是，由于字符串的特性，当使用了多个相同的字符串，实际在汇编层的代码中，会优化为一个字符串，所以在字符串加密的时候，我们要留意解密字符串的作用域。下面举一个例子</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span>  argc, <span class="keyword">char</span>** argv)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a = argc;</span><br><span class="line">    <span class="keyword">if</span>(a == <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个例子中使用了两个hello。如果我们在使用这个字符串时，调用的解密。那么下面else中的代码则会无法访问到bitcat。因为不在同一个作用域，所以为了防止出现这种情况，我在解密时再做一个特殊的处理，我们先获取第一个指令块的位置，然后所有的字符串解密指令块，都插入在最开始的位置，这样就不会出现作用域的问题了。最后贴上完整代码</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by king on 2020/10/7.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;kllvm/Transforms/Obfuscation/Utils.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;kllvm/Transforms/Obfuscation/KStringEncode.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> llvm;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> defaultKStringSize = <span class="number">0x3</span>;</span><br><span class="line">    <span class="keyword">static</span> cl::opt&lt;<span class="keyword">int</span>&gt;</span><br><span class="line">            KStringSize(<span class="string">&quot;kstr_size&quot;</span>, cl::desc(<span class="string">&quot;Choose the probability [%] each basic blocks will be obfuscated by the -kstr pass&quot;</span>), cl::value_desc(<span class="string">&quot;king string encode Encryption length&quot;</span>), cl::init(defaultKStringSize), cl::Optional);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">KStringEncode</span>:</span> <span class="keyword">public</span> FunctionPass&#123;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">char</span> ID; <span class="comment">// Pass identification</span></span><br><span class="line">        <span class="keyword">bool</span> flag;</span><br><span class="line">        KStringEncode() : FunctionPass(ID) &#123;&#125;</span><br><span class="line">        KStringEncode(<span class="keyword">bool</span> flag) : FunctionPass(ID) &#123;<span class="keyword">this</span>-&gt;flag = flag; KStringEncode();&#125;</span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">runOnFunction</span><span class="params">(Function &amp;F)</span></span>&#123;</span><br><span class="line">            <span class="keyword">if</span> ( !((KStringSize &gt; <span class="number">0</span>) &amp;&amp; (KStringSize &lt;= <span class="number">0x20</span>)) ) &#123;</span><br><span class="line">                errs()&lt;&lt;<span class="string">&quot;KStringEncode application basic blocks percentage -kstr_size=x must be 0 &lt; x &lt;= 100&quot;</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(toObfuscate(flag,&amp;F,<span class="string">&quot;kstr&quot;</span>)) &#123;</span><br><span class="line">                kstr(F);</span><br><span class="line"><span class="comment">//                printFunction(F);</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//转换字符串</span></span><br><span class="line">        <span class="function"><span class="built_in">std</span>::<span class="built_in">string</span> <span class="title">ConvertOpToString</span><span class="params">(Value* op)</span></span>&#123;</span><br><span class="line">            GlobalVariable* globalVar= dyn_cast&lt;GlobalVariable&gt;(op);</span><br><span class="line">            <span class="keyword">if</span>(!globalVar)&#123;</span><br><span class="line">                errs()&lt;&lt;<span class="string">&quot;dyn cast gloabl err&quot;</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ConstantDataSequential* cds=dyn_cast&lt;ConstantDataSequential&gt;(globalVar-&gt;getInitializer());</span><br><span class="line">            <span class="keyword">if</span>(!cds)&#123;</span><br><span class="line">                errs()&lt;&lt;<span class="string">&quot;dyn cast constant data err&quot;</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> cds-&gt;getRawDataValues();;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">kstr</span><span class="params">(Function&amp; func)</span></span>&#123;</span><br><span class="line">            Instruction* begin_ins=<span class="literal">nullptr</span>;</span><br><span class="line">            <span class="keyword">for</span>(BasicBlock&amp; bb:func)&#123;</span><br><span class="line">                <span class="keyword">for</span>(Instruction&amp; ins :bb)&#123;</span><br><span class="line">                    <span class="keyword">if</span>(begin_ins==<span class="literal">nullptr</span>)&#123;</span><br><span class="line">                        begin_ins=&amp;ins;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">for</span>(Value* val:ins.operands())&#123;</span><br><span class="line">                        Value* stripOp=val-&gt;stripPointerCasts();</span><br><span class="line">                        <span class="keyword">if</span>(stripOp-&gt;getName().contains(<span class="string">&quot;.str&quot;</span>))&#123;</span><br><span class="line">                            <span class="built_in">std</span>::<span class="built_in">string</span> strdata=ConvertOpToString(stripOp);</span><br><span class="line">                            errs()&lt;&lt;strdata&lt;&lt;<span class="string">&quot;\n&quot;</span>;</span><br><span class="line">                            <span class="keyword">if</span>(strdata.<span class="built_in">size</span>()&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">                                <span class="keyword">continue</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="comment">//加密流程</span></span><br><span class="line">                            <span class="keyword">uint8_t</span> keys[strdata.<span class="built_in">size</span>()];</span><br><span class="line">                            <span class="keyword">char</span> encres[strdata.<span class="built_in">size</span>()];</span><br><span class="line">                            <span class="keyword">int</span> idx=<span class="number">0</span>;</span><br><span class="line">                            <span class="built_in">memset</span>(encres,<span class="number">0</span>,strdata.<span class="built_in">size</span>());</span><br><span class="line">                            <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;strdata.<span class="built_in">size</span>();i++)&#123;</span><br><span class="line">                                <span class="keyword">uint8_t</span> randkey=llvm::cryptoutils-&gt;<span class="keyword">get_uint8_t</span>();</span><br><span class="line">                                keys[i]=randkey;</span><br><span class="line">                                <span class="keyword">int</span> enclen=randkey+defaultKStringSize;</span><br><span class="line">                                <span class="keyword">for</span>(<span class="keyword">int</span> y=randkey;y&lt;enclen;y++)&#123;</span><br><span class="line">                                    <span class="keyword">if</span>(y==randkey)&#123;</span><br><span class="line">                                        encres[i]=strdata[i]^y;</span><br><span class="line">                                    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(y==enclen<span class="number">-1</span>)&#123;</span><br><span class="line">                                        encres[i]=encres[i]^(~y);</span><br><span class="line">                                    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                                        encres[i]=encres[i]^y;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    <span class="built_in">printf</span>(<span class="string">&quot;%x &quot;</span>,encres[i]);</span><br><span class="line">                                    idx++;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            ArrayType* arrType=ArrayType::<span class="built_in">get</span>(Type::getInt8Ty(func.getContext()),strdata.<span class="built_in">size</span>());</span><br><span class="line">                            AllocaInst* arrayInst=<span class="keyword">new</span> AllocaInst(arrType,<span class="number">0</span>,<span class="literal">nullptr</span>,<span class="number">1</span>,Twine(stripOp-&gt;getName()+<span class="string">&quot;.arr&quot;</span>),begin_ins);</span><br><span class="line">                            BitCastInst* bitInst=<span class="keyword">new</span> BitCastInst(arrayInst,Type::getInt8PtrTy(func.getParent()-&gt;getContext()),Twine(stripOp-&gt;getName()+<span class="string">&quot;.bitcast&quot;</span>),begin_ins);</span><br><span class="line">                            <span class="comment">//创建一个对象用来存放当前加密字节解密时每次异或的结果</span></span><br><span class="line">                            AllocaInst* eor_res=<span class="keyword">new</span> AllocaInst(Type::getInt8Ty(func.getContext()),<span class="number">0</span>,<span class="literal">nullptr</span>,<span class="number">1</span>,Twine(stripOp-&gt;getName()+<span class="string">&quot;.alloc.res&quot;</span>),begin_ins);</span><br><span class="line">                            <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;strdata.<span class="built_in">size</span>();i++)&#123;</span><br><span class="line">                                <span class="keyword">uint8_t</span> randkey=keys[i];</span><br><span class="line">                                <span class="keyword">int</span> enclen=randkey+defaultKStringSize;</span><br><span class="line">                                ConstantInt* enc_const=ConstantInt::<span class="built_in">get</span>(Type::getInt8Ty(func.getContext()),encres[i]);</span><br><span class="line">                                <span class="comment">//用来存放解密结果的bitcat</span></span><br><span class="line">                                ConstantInt* i_const=ConstantInt::<span class="built_in">get</span>(Type::getInt8Ty(func.getContext()),i);</span><br><span class="line">                                GetElementPtrInst* element=GetElementPtrInst::CreateInBounds(bitInst,i_const);</span><br><span class="line">                                element-&gt;insertBefore(begin_ins);</span><br><span class="line">                                StoreInst* last_store=<span class="literal">nullptr</span>;</span><br><span class="line">                                <span class="keyword">for</span>(<span class="keyword">int</span> y=enclen<span class="number">-1</span>;y&gt;=randkey;y--)&#123;</span><br><span class="line">                                    <span class="comment">/*下面是获取y的指令块*/</span></span><br><span class="line">                                    <span class="comment">//先是创建一个数值y</span></span><br><span class="line">                                    ConstantInt *eor_data = ConstantInt::<span class="built_in">get</span>(Type::getInt8Ty(func.getContext()),y);</span><br><span class="line">                                    <span class="comment">//申请一个int8的内存来存放数值y</span></span><br><span class="line">                                    AllocaInst* eor_alloc=<span class="keyword">new</span> AllocaInst(Type::getInt8Ty(func.getContext()),<span class="number">0</span>,<span class="literal">nullptr</span>,<span class="number">1</span>,Twine(stripOp-&gt;getName()+<span class="string">&quot;.alloc.y&quot;</span>),begin_ins);</span><br><span class="line">                                    <span class="comment">//将数值y赋值给申请的内存空间</span></span><br><span class="line">                                    StoreInst* store_eor=<span class="keyword">new</span> StoreInst(eor_data,eor_alloc);</span><br><span class="line">                                    store_eor-&gt;insertAfter(eor_alloc);</span><br><span class="line">                                    <span class="comment">//从内存空间中加载里面的数值y</span></span><br><span class="line">                                    LoadInst* eor_load=<span class="keyword">new</span> LoadInst(eor_alloc,<span class="string">&quot;&quot;</span>);</span><br><span class="line">                                    eor_load-&gt;insertAfter(store_eor);</span><br><span class="line">                                    <span class="comment">//</span></span><br><span class="line">                                    <span class="keyword">if</span>(y==enclen<span class="number">-1</span>)&#123;</span><br><span class="line">                                        <span class="comment">//然后进行取反计算</span></span><br><span class="line">                                        BinaryOperator* binNotOp=BinaryOperator::CreateNot(eor_load);</span><br><span class="line">                                        binNotOp-&gt;insertAfter(eor_load);</span><br><span class="line">                                        <span class="comment">//然后异或</span></span><br><span class="line">                                        BinaryOperator* binXorOp=BinaryOperator::CreateXor(enc_const,binNotOp);</span><br><span class="line">                                        binXorOp-&gt;insertAfter(binNotOp);</span><br><span class="line">                                        <span class="comment">//将加密字节设置为上次异或的结果</span></span><br><span class="line">                                        StoreInst* store_eor_res=<span class="keyword">new</span> StoreInst(binXorOp,eor_res);</span><br><span class="line">                                        store_eor_res-&gt;insertAfter(binXorOp);</span><br><span class="line">                                    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                                        LoadInst* eor_load_res=<span class="keyword">new</span> LoadInst(eor_res,stripOp-&gt;getName()+<span class="string">&quot;.load&quot;</span>);</span><br><span class="line">                                        eor_load_res-&gt;insertAfter(store_eor);</span><br><span class="line">                                        <span class="comment">//然后进行异或计算</span></span><br><span class="line">                                        BinaryOperator* binXorOp=BinaryOperator::CreateXor(eor_load_res,eor_load);</span><br><span class="line">                                        binXorOp-&gt;insertAfter(eor_load);</span><br><span class="line">                                        <span class="comment">//将计算后的结果存放回数组中</span></span><br><span class="line">                                        StoreInst* store_data=<span class="keyword">new</span> StoreInst(binXorOp,eor_res);</span><br><span class="line">                                        store_data-&gt;insertAfter(binXorOp);</span><br><span class="line">                                        <span class="keyword">if</span>(y==randkey)&#123;</span><br><span class="line">                                            last_store=store_data;</span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="comment">//读取这个字节经过多次异或后的最终结果</span></span><br><span class="line">                                LoadInst* dec_res=<span class="keyword">new</span> LoadInst(eor_res,stripOp-&gt;getName()+<span class="string">&quot;.dec.res&quot;</span>);</span><br><span class="line">                                dec_res-&gt;insertAfter(last_store);</span><br><span class="line">                                <span class="comment">//将这个结果写入到前面用来存放的解密结果bitcat处</span></span><br><span class="line">                                StoreInst* store_data=<span class="keyword">new</span> StoreInst(dec_res,element);</span><br><span class="line">                                store_data-&gt;insertAfter(dec_res);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="comment">//将字符串操作数替换为我们准备好的解密结果的bitInst</span></span><br><span class="line">                            val-&gt;replaceAllUsesWith(bitInst);</span><br><span class="line">                            <span class="comment">//然后再删掉之前我们获取到的字符串的明文部分。这样就只有密文数据和密文解密的流程，最后动态执行拿到解密字符串了</span></span><br><span class="line">                            GlobalVariable* globalVar= dyn_cast&lt;GlobalVariable&gt;(stripOp);</span><br><span class="line">                            globalVar-&gt;eraseFromParent();</span><br><span class="line"></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">char</span> KStringEncode::ID = <span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> RegisterPass&lt;KStringEncode&gt; <span class="title">X</span><span class="params">(<span class="string">&quot;kstr&quot;</span>, <span class="string">&quot;inserting bogus control flow&quot;</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">Pass *<span class="title">llvm::createKStringEncode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> KStringEncode();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Pass *<span class="title">llvm::createKStringEncode</span><span class="params">(<span class="keyword">bool</span> flag)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> KStringEncode(flag);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>最后我们来执行测试一下,执行下面的命令使用这个pass进行加密</p>
<p><code>clang -Xclang -load -Xclang /mnt/hgfs/kali_share/kOLLVM/cmake-build-debug/ollvm/lib/Transforms/Obfuscation/LLVMObfuscation.so -mllvm -kstr -mllvm -kstr_size=10 -emit-llvm -S  main.cpp -o main_ollvm_kstr.ll</code></p>
<p>检查下这个ir文件没啥问题。那么编译成二进制。</p>
<p><code>clang main_ollvm_kstr.ll -o main</code></p>
<p>接着我们再用ida打开看看这个二进制文件的main函数里面的字符串是否已经被混淆了</p>
<p>先看看测试混淆的目标代码</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> <span class="keyword">const</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span>* str = <span class="string">&quot;kanxue&quot;</span>;</span><br><span class="line">    <span class="keyword">int</span> n = argc;</span><br><span class="line">    <span class="keyword">if</span> (n &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;hello ollvm:%d\r\n&quot;</span>, n);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, str);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后再看看混淆后，使用ida打开的结果</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> v4; <span class="comment">// [rsp+3Bh] [rbp-65h]</span></span><br><span class="line">  <span class="keyword">char</span> v5; <span class="comment">// [rsp+3Ch] [rbp-64h]</span></span><br><span class="line">  <span class="keyword">char</span> v6; <span class="comment">// [rsp+3Dh] [rbp-63h]</span></span><br><span class="line">  <span class="keyword">char</span> v7; <span class="comment">// [rsp+3Eh] [rbp-62h]</span></span><br><span class="line">  <span class="keyword">char</span> v8; <span class="comment">// [rsp+3Fh] [rbp-61h]</span></span><br><span class="line">  <span class="keyword">char</span> v9; <span class="comment">// [rsp+40h] [rbp-60h]</span></span><br><span class="line">  <span class="keyword">char</span> v10; <span class="comment">// [rsp+41h] [rbp-5Fh]</span></span><br><span class="line">  <span class="keyword">char</span> v11; <span class="comment">// [rsp+42h] [rbp-5Eh]</span></span><br><span class="line">  <span class="keyword">char</span> v12; <span class="comment">// [rsp+43h] [rbp-5Dh]</span></span><br><span class="line">  <span class="keyword">char</span> v13; <span class="comment">// [rsp+44h] [rbp-5Ch]</span></span><br><span class="line">  <span class="keyword">char</span> v14; <span class="comment">// [rsp+45h] [rbp-5Bh]</span></span><br><span class="line">  <span class="keyword">char</span> v15; <span class="comment">// [rsp+46h] [rbp-5Ah]</span></span><br><span class="line">  <span class="keyword">char</span> v16; <span class="comment">// [rsp+47h] [rbp-59h]</span></span><br><span class="line">  <span class="keyword">char</span> v17; <span class="comment">// [rsp+48h] [rbp-58h]</span></span><br><span class="line">  <span class="keyword">char</span> v18; <span class="comment">// [rsp+49h] [rbp-57h]</span></span><br><span class="line">  <span class="keyword">char</span> v19; <span class="comment">// [rsp+4Ah] [rbp-56h]</span></span><br><span class="line">  <span class="keyword">char</span> v20; <span class="comment">// [rsp+4Bh] [rbp-55h]</span></span><br><span class="line">  <span class="keyword">char</span> v21; <span class="comment">// [rsp+4Ch] [rbp-54h]</span></span><br><span class="line">  <span class="keyword">char</span> v22; <span class="comment">// [rsp+4Dh] [rbp-53h]</span></span><br><span class="line">  <span class="keyword">char</span> v23; <span class="comment">// [rsp+4Eh] [rbp-52h]</span></span><br><span class="line">  <span class="keyword">char</span> v24; <span class="comment">// [rsp+4Fh] [rbp-51h]</span></span><br><span class="line">  <span class="keyword">char</span> v25; <span class="comment">// [rsp+50h] [rbp-50h]</span></span><br><span class="line">  <span class="keyword">char</span> v26; <span class="comment">// [rsp+51h] [rbp-4Fh]</span></span><br><span class="line">  <span class="keyword">char</span> v27; <span class="comment">// [rsp+52h] [rbp-4Eh]</span></span><br><span class="line">  <span class="keyword">char</span> v28; <span class="comment">// [rsp+53h] [rbp-4Dh]</span></span><br><span class="line">  <span class="keyword">char</span> v29; <span class="comment">// [rsp+54h] [rbp-4Ch]</span></span><br><span class="line">  <span class="keyword">char</span> v30; <span class="comment">// [rsp+55h] [rbp-4Bh]</span></span><br><span class="line">  <span class="keyword">char</span> v31; <span class="comment">// [rsp+56h] [rbp-4Ah]</span></span><br><span class="line">  <span class="keyword">char</span> v32; <span class="comment">// [rsp+57h] [rbp-49h]</span></span><br><span class="line">  <span class="keyword">char</span> v33; <span class="comment">// [rsp+58h] [rbp-48h]</span></span><br><span class="line">  <span class="keyword">char</span> v34; <span class="comment">// [rsp+59h] [rbp-47h]</span></span><br><span class="line">  <span class="keyword">char</span> v35; <span class="comment">// [rsp+5Ah] [rbp-46h]</span></span><br><span class="line">  <span class="keyword">char</span> v36; <span class="comment">// [rsp+5Bh] [rbp-45h]</span></span><br><span class="line">  <span class="keyword">char</span> v37; <span class="comment">// [rsp+5Ch] [rbp-44h]</span></span><br><span class="line">  <span class="keyword">char</span> v38; <span class="comment">// [rsp+5Dh] [rbp-43h]</span></span><br><span class="line">  <span class="keyword">char</span> v39; <span class="comment">// [rsp+5Eh] [rbp-42h]</span></span><br><span class="line">  <span class="keyword">char</span> v40; <span class="comment">// [rsp+5Fh] [rbp-41h]</span></span><br><span class="line">  <span class="keyword">char</span> v41; <span class="comment">// [rsp+60h] [rbp-40h]</span></span><br><span class="line">  <span class="keyword">char</span> v42; <span class="comment">// [rsp+61h] [rbp-3Fh]</span></span><br><span class="line">  <span class="keyword">char</span> v43; <span class="comment">// [rsp+62h] [rbp-3Eh]</span></span><br><span class="line">  <span class="keyword">char</span> v44; <span class="comment">// [rsp+63h] [rbp-3Dh]</span></span><br><span class="line">  <span class="keyword">char</span> v45; <span class="comment">// [rsp+64h] [rbp-3Ch]</span></span><br><span class="line">  <span class="keyword">char</span> v46; <span class="comment">// [rsp+65h] [rbp-3Bh]</span></span><br><span class="line">  <span class="keyword">char</span> v47; <span class="comment">// [rsp+66h] [rbp-3Ah]</span></span><br><span class="line">  <span class="keyword">char</span> v48; <span class="comment">// [rsp+67h] [rbp-39h]</span></span><br><span class="line">  <span class="keyword">char</span> v49; <span class="comment">// [rsp+68h] [rbp-38h]</span></span><br><span class="line">  <span class="keyword">char</span> v50; <span class="comment">// [rsp+69h] [rbp-37h]</span></span><br><span class="line">  <span class="keyword">char</span> v51; <span class="comment">// [rsp+6Ah] [rbp-36h]</span></span><br><span class="line">  <span class="keyword">char</span> v52; <span class="comment">// [rsp+6Bh] [rbp-35h]</span></span><br><span class="line">  <span class="keyword">char</span> v53; <span class="comment">// [rsp+6Ch] [rbp-34h]</span></span><br><span class="line">  <span class="keyword">char</span> v54; <span class="comment">// [rsp+6Dh] [rbp-33h]</span></span><br><span class="line">  <span class="keyword">char</span> v55; <span class="comment">// [rsp+6Eh] [rbp-32h]</span></span><br><span class="line">  <span class="keyword">char</span> v56; <span class="comment">// [rsp+6Fh] [rbp-31h]</span></span><br><span class="line">  <span class="keyword">char</span> v57; <span class="comment">// [rsp+70h] [rbp-30h]</span></span><br><span class="line">  <span class="keyword">char</span> v58; <span class="comment">// [rsp+71h] [rbp-2Fh]</span></span><br><span class="line">  <span class="keyword">char</span> v59; <span class="comment">// [rsp+72h] [rbp-2Eh]</span></span><br><span class="line">  <span class="keyword">char</span> v60; <span class="comment">// [rsp+73h] [rbp-2Dh]</span></span><br><span class="line">  <span class="keyword">char</span> v61; <span class="comment">// [rsp+74h] [rbp-2Ch]</span></span><br><span class="line">  <span class="keyword">char</span> v62; <span class="comment">// [rsp+75h] [rbp-2Bh]</span></span><br><span class="line">  <span class="keyword">char</span> v63; <span class="comment">// [rsp+76h] [rbp-2Ah]</span></span><br><span class="line">  <span class="keyword">char</span> v64; <span class="comment">// [rsp+77h] [rbp-29h]</span></span><br><span class="line">  <span class="keyword">char</span> v65; <span class="comment">// [rsp+78h] [rbp-28h]</span></span><br><span class="line">  <span class="keyword">char</span> v66; <span class="comment">// [rsp+79h] [rbp-27h]</span></span><br><span class="line">  <span class="keyword">char</span> v67; <span class="comment">// [rsp+7Ah] [rbp-26h]</span></span><br><span class="line">  <span class="keyword">char</span> v68; <span class="comment">// [rsp+7Bh] [rbp-25h]</span></span><br><span class="line">  <span class="keyword">char</span> v69; <span class="comment">// [rsp+7Ch] [rbp-24h]</span></span><br><span class="line">  <span class="keyword">char</span> v70; <span class="comment">// [rsp+7Dh] [rbp-23h]</span></span><br><span class="line">  <span class="keyword">char</span> v71; <span class="comment">// [rsp+7Eh] [rbp-22h]</span></span><br><span class="line">  <span class="keyword">char</span> v72; <span class="comment">// [rsp+7Fh] [rbp-21h]</span></span><br><span class="line">  <span class="keyword">char</span> v73; <span class="comment">// [rsp+80h] [rbp-20h]</span></span><br><span class="line">  <span class="keyword">char</span> v74; <span class="comment">// [rsp+81h] [rbp-1Fh]</span></span><br><span class="line">  <span class="keyword">char</span> v75; <span class="comment">// [rsp+82h] [rbp-1Eh]</span></span><br><span class="line">  <span class="keyword">char</span> v76; <span class="comment">// [rsp+83h] [rbp-1Dh]</span></span><br><span class="line">  <span class="keyword">char</span> v77; <span class="comment">// [rsp+84h] [rbp-1Ch]</span></span><br><span class="line">  <span class="keyword">char</span> v78; <span class="comment">// [rsp+85h] [rbp-1Bh]</span></span><br><span class="line">  <span class="keyword">char</span> v79; <span class="comment">// [rsp+86h] [rbp-1Ah]</span></span><br><span class="line">  <span class="keyword">char</span> v80; <span class="comment">// [rsp+87h] [rbp-19h]</span></span><br><span class="line">  <span class="keyword">char</span> v81; <span class="comment">// [rsp+88h] [rbp-18h]</span></span><br><span class="line">  <span class="keyword">char</span> v82; <span class="comment">// [rsp+89h] [rbp-17h]</span></span><br><span class="line">  <span class="keyword">char</span> v83; <span class="comment">// [rsp+8Ah] [rbp-16h]</span></span><br><span class="line">  <span class="keyword">char</span> v84; <span class="comment">// [rsp+8Bh] [rbp-15h]</span></span><br><span class="line">  <span class="keyword">char</span> v85; <span class="comment">// [rsp+8Ch] [rbp-14h]</span></span><br><span class="line">  <span class="keyword">char</span> v86; <span class="comment">// [rsp+8Dh] [rbp-13h]</span></span><br><span class="line">  <span class="keyword">char</span> v87; <span class="comment">// [rsp+8Eh] [rbp-12h]</span></span><br><span class="line">  <span class="keyword">char</span> v88; <span class="comment">// [rsp+8Fh] [rbp-11h]</span></span><br><span class="line">  <span class="keyword">char</span> v89; <span class="comment">// [rsp+90h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">char</span> v90; <span class="comment">// [rsp+91h] [rbp-Fh]</span></span><br><span class="line">  <span class="keyword">char</span> v91; <span class="comment">// [rsp+92h] [rbp-Eh]</span></span><br><span class="line">  <span class="keyword">char</span> v92; <span class="comment">// [rsp+93h] [rbp-Dh]</span></span><br><span class="line">  <span class="keyword">char</span> v93; <span class="comment">// [rsp+94h] [rbp-Ch]</span></span><br><span class="line">  <span class="keyword">char</span> v94; <span class="comment">// [rsp+95h] [rbp-Bh]</span></span><br><span class="line">  <span class="keyword">char</span> v95; <span class="comment">// [rsp+96h] [rbp-Ah]</span></span><br><span class="line">  <span class="keyword">char</span> v96; <span class="comment">// [rsp+97h] [rbp-9h]</span></span><br><span class="line">  <span class="keyword">char</span> v97; <span class="comment">// [rsp+98h] [rbp-8h]</span></span><br><span class="line">  <span class="keyword">char</span> v98; <span class="comment">// [rsp+99h] [rbp-7h]</span></span><br><span class="line">  <span class="keyword">char</span> v99; <span class="comment">// [rsp+9Ah] [rbp-6h]</span></span><br><span class="line">  <span class="keyword">char</span> v100; <span class="comment">// [rsp+9Bh] [rbp-5h]</span></span><br><span class="line">  <span class="keyword">char</span> v101; <span class="comment">// [rsp+9Ch] [rbp-4h]</span></span><br><span class="line">  <span class="keyword">char</span> v102; <span class="comment">// [rsp+9Dh] [rbp-3h]</span></span><br><span class="line">  <span class="keyword">char</span> v103; <span class="comment">// [rsp+9Eh] [rbp-2h]</span></span><br><span class="line">  <span class="keyword">char</span> v104; <span class="comment">// [rsp+9Fh] [rbp-1h]</span></span><br><span class="line"></span><br><span class="line">  v96 = <span class="number">94</span>;</span><br><span class="line">  v95 = <span class="number">93</span>;</span><br><span class="line">  v94 = <span class="number">92</span>;</span><br><span class="line">  v98 = <span class="number">107</span>;</span><br><span class="line">  v93 = <span class="number">237</span>;</span><br><span class="line">  v92 = <span class="number">236</span>;</span><br><span class="line">  v91 = <span class="number">235</span>;</span><br><span class="line">  v99 = <span class="number">97</span>;</span><br><span class="line">  v90 = <span class="number">122</span>;</span><br><span class="line">  v89 = <span class="number">121</span>;</span><br><span class="line">  v88 = <span class="number">120</span>;</span><br><span class="line">  v100 = <span class="number">110</span>;</span><br><span class="line">  v87 = <span class="number">129</span>;</span><br><span class="line">  v86 = <span class="number">128</span>;</span><br><span class="line">  v85 = <span class="number">127</span>;</span><br><span class="line">  v101 = <span class="number">120</span>;</span><br><span class="line">  v84 = <span class="number">-55</span>;</span><br><span class="line">  v83 = <span class="number">-56</span>;</span><br><span class="line">  v82 = <span class="number">-57</span>;</span><br><span class="line">  v102 = <span class="number">117</span>;</span><br><span class="line">  v81 = <span class="number">-100</span>;</span><br><span class="line">  v80 = <span class="number">-101</span>;</span><br><span class="line">  v79 = <span class="number">-102</span>;</span><br><span class="line">  v103 = <span class="number">101</span>;</span><br><span class="line">  v78 = <span class="number">87</span>;</span><br><span class="line">  v77 = <span class="number">86</span>;</span><br><span class="line">  v76 = <span class="number">85</span>;</span><br><span class="line">  v97 = <span class="number">0</span>;</span><br><span class="line">  v104 = <span class="number">0</span>;</span><br><span class="line">  v57 = <span class="number">-104</span>;</span><br><span class="line">  v56 = <span class="number">-105</span>;</span><br><span class="line">  v55 = <span class="number">-106</span>;</span><br><span class="line">  v59 = <span class="number">104</span>;</span><br><span class="line">  v54 = <span class="number">73</span>;</span><br><span class="line">  v53 = <span class="number">72</span>;</span><br><span class="line">  v52 = <span class="number">71</span>;</span><br><span class="line">  v60 = <span class="number">101</span>;</span><br><span class="line">  v51 = <span class="number">-109</span>;</span><br><span class="line">  v50 = <span class="number">-110</span>;</span><br><span class="line">  v49 = <span class="number">-111</span>;</span><br><span class="line">  v61 = <span class="number">108</span>;</span><br><span class="line">  v48 = <span class="number">42</span>;</span><br><span class="line">  v47 = <span class="number">41</span>;</span><br><span class="line">  v46 = <span class="number">40</span>;</span><br><span class="line">  v62 = <span class="number">108</span>;</span><br><span class="line">  v45 = <span class="number">-81</span>;</span><br><span class="line">  v44 = <span class="number">-82</span>;</span><br><span class="line">  v43 = <span class="number">-83</span>;</span><br><span class="line">  v63 = <span class="number">111</span>;</span><br><span class="line">  v42 = <span class="number">-78</span>;</span><br><span class="line">  v41 = <span class="number">-79</span>;</span><br><span class="line">  v40 = <span class="number">-80</span>;</span><br><span class="line">  v64 = <span class="number">32</span>;</span><br><span class="line">  v39 = <span class="number">-116</span>;</span><br><span class="line">  v38 = <span class="number">-117</span>;</span><br><span class="line">  v37 = <span class="number">-118</span>;</span><br><span class="line">  v65 = <span class="number">111</span>;</span><br><span class="line">  v36 = <span class="number">99</span>;</span><br><span class="line">  v35 = <span class="number">98</span>;</span><br><span class="line">  v34 = <span class="number">97</span>;</span><br><span class="line">  v66 = <span class="number">108</span>;</span><br><span class="line">  v33 = <span class="number">12</span>;</span><br><span class="line">  v32 = <span class="number">11</span>;</span><br><span class="line">  v31 = <span class="number">10</span>;</span><br><span class="line">  v67 = <span class="number">108</span>;</span><br><span class="line">  v30 = <span class="number">95</span>;</span><br><span class="line">  v29 = <span class="number">94</span>;</span><br><span class="line">  v28 = <span class="number">93</span>;</span><br><span class="line">  v68 = <span class="number">118</span>;</span><br><span class="line">  v27 = <span class="number">9</span>;</span><br><span class="line">  v26 = <span class="number">8</span>;</span><br><span class="line">  v25 = <span class="number">7</span>;</span><br><span class="line">  v69 = <span class="number">109</span>;</span><br><span class="line">  v24 = <span class="number">26</span>;</span><br><span class="line">  v23 = <span class="number">25</span>;</span><br><span class="line">  v22 = <span class="number">24</span>;</span><br><span class="line">  v70 = <span class="number">58</span>;</span><br><span class="line">  v21 = <span class="number">109</span>;</span><br><span class="line">  v20 = <span class="number">108</span>;</span><br><span class="line">  v19 = <span class="number">107</span>;</span><br><span class="line">  v71 = <span class="number">37</span>;</span><br><span class="line">  v18 = <span class="number">92</span>;</span><br><span class="line">  v17 = <span class="number">91</span>;</span><br><span class="line">  v16 = <span class="number">90</span>;</span><br><span class="line">  v72 = <span class="number">100</span>;</span><br><span class="line">  v15 = <span class="number">-50</span>;</span><br><span class="line">  v14 = <span class="number">-51</span>;</span><br><span class="line">  v13 = <span class="number">-52</span>;</span><br><span class="line">  v73 = <span class="number">13</span>;</span><br><span class="line">  v12 = <span class="number">119</span>;</span><br><span class="line">  v11 = <span class="number">118</span>;</span><br><span class="line">  v10 = <span class="number">117</span>;</span><br><span class="line">  v74 = <span class="number">10</span>;</span><br><span class="line">  v9 = <span class="number">4</span>;</span><br><span class="line">  v8 = <span class="number">3</span>;</span><br><span class="line">  v7 = <span class="number">2</span>;</span><br><span class="line">  v58 = <span class="number">0</span>;</span><br><span class="line">  v75 = <span class="number">0</span>;</span><br><span class="line">  v4 = <span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">  v5 = <span class="string">&#x27;s&#x27;</span>;</span><br><span class="line">  v6 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( argc &lt; <span class="number">2</span> )</span><br><span class="line">    <span class="built_in">printf</span>(&amp;v4, &amp;v98, &amp;v4);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">printf</span>(&amp;v59, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)argc, &amp;v4);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>尽管看起来好像已经混淆成功了，但是实际上依然可以看到ida给我们自动解析了很多，字符串基本被还原了一些，比如找到&amp;98然后往后的几个字节存放的就已经是明文了。这里我们只要再加一层混淆。让代码的结构更加混乱。ida就无法自动还原出我们的字符串明文了。再增加一些参数混淆下。</p>
<p><code>clang -Xclang -load -Xclang /mnt/hgfs/kali_share/kOLLVM/cmake-build-debug/ollvm/lib/Transforms/Obfuscation/LLVMObfuscation.so -mllvm -kstr -mllvm -kstr_size=10 -mllvm -bcf -mllvm -bcf_loop=3 -mllvm -fla -emit-llvm -S  main.cpp -o main_ollvm_kstr.ll</code></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">king</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://missking.cc/2020/10/12/ollvm/">http://missking.cc/2020/10/12/ollvm/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://missking.cc" target="_blank">king的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%9F%BA%E7%A1%80/">基础</a></div><div class="post_share"><div class="social-share" data-image="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/10/16/unicorn1/"><img class="prev-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">unicorn初学</div></div></a></div><div class="next-post pull-right"><a href="/2020/09/11/llvm2/"><img class="next-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">llvm的pass</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2020/08/12/ClassStructure/" title="类对象的内存布局"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-08-12</div><div class="title">类对象的内存布局</div></div></a></div><div><a href="/2020/11/03/fart/" title="fart的理解和分析过程"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-11-03</div><div class="title">fart的理解和分析过程</div></div></a></div><div><a href="/2020/09/10/llvm1/" title="llvm简单的使用"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-09-10</div><div class="title">llvm简单的使用</div></div></a></div><div><a href="/2021/06/24/fridatools/" title="菜鸟学飞之frida整合怪"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-06-24</div><div class="title">菜鸟学飞之frida整合怪</div></div></a></div><div><a href="/2020/09/11/llvm2/" title="llvm的pass"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-09-11</div><div class="title">llvm的pass</div></div></a></div><div><a href="/2020/11/03/unicorn2/" title="AndroidNativeEmu和unidbg对抗ollvm的字符串混淆"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-11-03</div><div class="title">AndroidNativeEmu和unidbg对抗ollvm的字符串混淆</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div><div id="comment-switch"><span class="first-comment">Valine</span><span class="switch-btn"></span><span class="second-comment">Disqus</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div><div><div id="disqus_thread"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/assets/blogImg/litten.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">king</div><div class="author-info__description"></div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">36</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">16</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/dqzg12300"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/dqzg12300" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:king910827@163.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">新时代农民工</div></div><div class="sticky_layout"><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/09/05/kernel1-0/" title="aosp12内核编译开启硬件断点和kprobes记录">aosp12内核编译开启硬件断点和kprobes记录</a><time datetime="2022-09-05T13:01:17.000Z" title="发表于 2022-09-05 13:01:17">2022-09-05</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/04/11/Kernel1/" title="linux内核书籍阅读笔记1">linux内核书籍阅读笔记1</a><time datetime="2022-04-11T22:38:34.000Z" title="发表于 2022-04-11 22:38:34">2022-04-11</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/03/20/CPU%E5%9F%BA%E7%A1%80/" title="逆向工程权威指南的看书笔记">逆向工程权威指南的看书笔记</a><time datetime="2022-03-20T15:38:13.000Z" title="发表于 2022-03-20 15:38:13">2022-03-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/01/27/MikRom/" title="FartExt超进化之奇奇怪怪的新ROM工具MikRom">FartExt超进化之奇奇怪怪的新ROM工具MikRom</a><time datetime="2022-01-27T13:48:38.000Z" title="发表于 2022-01-27 13:48:38">2022-01-27</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2021/07/26/fartext/" title="FartExt之优化更深主动调用的FART10">FartExt之优化更深主动调用的FART10</a><time datetime="2021-07-26T21:31:05.000Z" title="发表于 2021-07-26 21:31:05">2021-07-26</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By king</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">本地搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'ihIPa0lRcHcfVzXqcboVznyu-gzGzoHsz',
      appKey: 'YB8y22BOhfzrVioINMUoEqxd',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !true) {
  if (true) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script><script>function loadDisqus () {
  var disqus_config = function () {
    this.page.url = 'http://missking.cc/2020/10/12/ollvm/'
    this.page.identifier = '2020/10/12/ollvm/'
    this.page.title = 'ollvm自定义string加密pass'
  };

  window.disqusReset = () => {
    DISQUS.reset({
      reload: true,
      config: disqus_config
    })
  }

  if (window.DISQUS) disqusReset()
  else {
    (function() { 
      var d = document, s = d.createElement('script');
      s.src = 'https://.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  }
}

if ('Valine' === 'Disqus' || !true) {
  if (true) btf.loadComment(document.getElementById('disqus_thread'), loadDisqus)
  else loadDisqus()
} else {
  function loadOtherComment () {
    loadDisqus()
  }
}
</script></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-nest.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>